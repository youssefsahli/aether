<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e1e2e">
    <title>Aether v3 - Ace Flux</title>
    
    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-tomorrow_night_eighties.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-chrome.min.js"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            /* Catppuccin Mocha Defaults */
            --bg: #1e1e2e;
            --sidebar-bg: #181825;
            --header-bg: #11111b;
            --tab-inactive: #11111b;
            --tab-active: #1e1e2e;
            --text: #cdd6f4;
            --text-dim: #9399b2;
            --accent: #89b4fa;
            --accent-sec: #b4befe;
            --border: #313244;
            --highlight: #313244;
            --cursor: #f5e0dc;
            --status-bg: #89b4fa;
            --status-fg: #1e1e2e;
            
            --font-code: 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
            --header-h: 32px; /* Tighter Header */
            --footer-h: 22px; /* Tighter Footer */
            --sidebar-w: 220px;
            --tab-h: 28px;
        }

        [data-theme="macchiato"] {
            --bg: #24273a; --sidebar-bg: #1e2030; --header-bg: #181926;
            --tab-inactive: #181926; --tab-active: #24273a;
            --text: #cad3f5; --text-dim: #939ab7;
            --accent: #8aadf4; --accent-sec: #b7bdf8;
            --border: #363a4f; --highlight: #363a4f;
            --cursor: #f4dbd6; --status-bg: #8aadf4; --status-fg: #24273a;
        }

        [data-theme="frappe"] {
            --bg: #303446; --sidebar-bg: #292c3c; --header-bg: #232634;
            --tab-inactive: #232634; --tab-active: #303446;
            --text: #c6d0f5; --text-dim: #949cbb;
            --accent: #8caaee; --accent-sec: #babbf1;
            --border: #414559; --highlight: #414559;
            --cursor: #f2d5cf; --status-bg: #8caaee; --status-fg: #303446;
        }

        [data-theme="latte"] {
            --bg: #eff1f5; --sidebar-bg: #e6e9ef; --header-bg: #dce0e8;
            --tab-inactive: #dce0e8; --tab-active: #eff1f5;
            --text: #4c4f69; --text-dim: #9ca0b0;
            --accent: #1e66f5; --accent-sec: #7287fd;
            --border: #bcc0cc; --highlight: #ccd0da;
            --cursor: #dc8a78; --status-bg: #1e66f5; --status-fg: #eff1f5;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background: var(--bg); color: var(--text);
            height: 100dvh; width: 100vw; overflow: hidden;
            font-family: var(--font-code); display: flex; flex-direction: column;
            font-size: 13px; letter-spacing: -0.01em;
            transition: background 0.2s, color 0.2s;
        }
        
        /* Dragging state to prevent iframe capture */
        body.resizing { cursor: col-resize !important; user-select: none; }
        body.resizing iframe { pointer-events: none; }
        
        /* Drag & Drop Overlay */
        body.drag-over::after {
            content: 'DROP FILE TO OPEN';
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            color: var(--accent); font-weight: 800; font-size: 24px; z-index: 999;
            backdrop-filter: blur(4px); pointer-events: none;
        }

        svg.icon { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* --- Layout --- */
        #app-shell { display: flex; flex: 1; overflow: hidden; }
        
        aside {
            width: var(--sidebar-w); background: var(--sidebar-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 10; flex-shrink: 0;
            transition: margin-left 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        aside.collapsed { margin-left: calc(var(--sidebar-w) * -1); }
        
        .side-header { 
            padding: 8px 12px; font-weight: 800; font-size: 10px;
            color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px;
            display:flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border); height: 32px;
        }
        
        .file-tree { flex: 1; overflow-y: auto; padding: 4px 0; }
        
        .tree-item {
            padding: 4px 12px; font-size: 12px; color: var(--text-dim); cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            white-space: nowrap; overflow: hidden; border-left: 2px solid transparent; height: 24px;
        }
        .tree-item-label { display: flex; align-items: center; gap: 6px; overflow: hidden; text-overflow: ellipsis; }
        .tree-item:hover { background: var(--highlight); color: var(--text); }
        .tree-item.active { background: var(--highlight); color: var(--accent); border-left-color: var(--accent); font-weight: 600; }
        
        .tree-actions { display: flex; gap: 4px; opacity: 0; }
        .tree-item:hover .tree-actions { opacity: 1; }
        
        .action-btn { padding: 2px; border-radius: 3px; cursor: pointer; display: flex; align-items: center; }
        .action-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .action-delete:hover { background: rgba(255,100,100,0.2); color: #ff8888; }

        main { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; background: var(--bg); }

        #tabs-scroll { 
            height: var(--tab-h); background: var(--header-bg); display: flex; 
            overflow-x: auto; scrollbar-width: none;
            gap: 1px; padding: 0; border-bottom: 1px solid var(--border);
        }
        #tabs-scroll::-webkit-scrollbar { display: none; }
        
        .tab {
            height: 100%; padding: 0 10px; display: flex; align-items: center;
            color: var(--text-dim); font-size: 11px; cursor: pointer; 
            min-width: 80px; max-width: 180px; position: relative;
            background: var(--tab-inactive); justify-content: space-between;
            border-right: 1px solid var(--border); transition: all 0.1s;
        }
        .tab:hover { background: var(--highlight); color: var(--text); }
        .tab.active { background: var(--bg); color: var(--accent); font-weight: 600; border-top: 2px solid var(--accent); margin-top: -2px; }
        
        .tab-close { opacity: 0; padding: 2px; font-size: 14px; margin-left: 6px; line-height: 0.8; border-radius: 3px; }
        .tab:hover .tab-close { opacity: 0.7; }
        .tab-close:hover { background: rgba(255,50,50,0.2); color: #ff5555; opacity: 1 !important; }
        
        .unsaved-dot { width: 6px; height: 6px; background: var(--accent-sec); border-radius: 50%; display: none; margin-left: auto; }
        .tab.dirty .unsaved-dot { display: block; }
        .tab.dirty:hover .unsaved-dot { display: none; }
        .tab.dirty:hover .tab-close { display: flex; }

        .breadcrumbs {
            height: 22px; background: var(--bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 12px; gap: 8px;
            font-size: 10px; color: var(--text-dim);
        }

        #editor-split { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        #code-stage { flex: 1; position: relative; }

        #preview-pane { 
            width: 0; border-left: 1px solid var(--border); background: var(--bg); 
            display: flex; flex-direction: column; overflow: hidden;
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .preview-active #preview-pane { width: 50%; } 
        iframe { width: 100%; height: 100%; border: none; background: #fff; }
        
        #resizer { 
            width: 4px; background: transparent; cursor: col-resize; position: absolute; top: 0; bottom: 0; z-index: 50;
            display: none; transition: background 0.2s;
        }
        #resizer:hover, #resizer.active { background: var(--accent); }
        .preview-active #resizer { display: block; }

        header {
            height: var(--header-h); background: var(--header-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 8px; gap: 8px;
        }
        .logo { font-weight: 800; color: var(--accent); font-size: 13px; margin-right: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .toolbar { display: flex; align-items: center; gap: 4px; margin-left: auto; }
        
        .theme-swatches { display: flex; gap: 4px; margin-right: 8px; }
        .theme-swatch { width: 10px; height: 10px; cursor: pointer; border: 1px solid var(--border); border-radius: 50%; }
        .theme-swatch:hover { transform: scale(1.2); border-color: var(--text); }
        .swatch-latte { background: #eff1f5; }
        .swatch-frappe { background: #303446; }
        .swatch-macchiato { background: #24273a; }
        .swatch-mocha { background: #1e1e2e; }

        footer {
            height: var(--footer-h); background: var(--header-bg); color: var(--text-dim);
            display: flex; align-items: center; justify-content: space-between; padding: 0;
            font-size: 10px; font-weight: 500; border-top: 1px solid var(--border);
            user-select: none; z-index: 50; position: relative;
        }
        .stat-group { display: flex; height: 100%; }
        .stat-box { 
            padding: 0 10px; height: 100%; display: flex; align-items: center; 
            border-right: 1px solid var(--border); gap: 6px;
        }
        .stat-box:last-child { border-right: none; }
        .stat-primary { background: var(--accent); color: var(--status-fg); font-weight: 700; border-right: none; }
        
        .btn {
            background: transparent; border: 1px solid transparent; color: var(--text-dim);
            padding: 4px; width: 24px; height: 24px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            border-radius: 3px; transition: all 0.1s;
        }
        .btn:hover { background: var(--highlight); color: var(--text); }
        .btn.primary { color: var(--accent); background: rgba(137, 180, 250, 0.1); }
        .btn.primary:hover { background: var(--accent); color: var(--bg); }
        
        .overlay-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
            display: none; align-items: flex-start; justify-content: center; padding-top: 60px;
            backdrop-filter: blur(2px);
        }
        .dialog {
            background: var(--bg); border: 1px solid var(--border); width: 450px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column;
            border-radius: 6px; overflow: hidden;
        }

        .dialog input {
            background: var(--header-bg); border: none; color: var(--text); padding: 12px 16px;
            font-size: 13px; width: 100%; border-bottom: 1px solid var(--border);
            font-family: var(--font-code);
        }
        .cmd-item { padding: 8px 16px; cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; align-items: center; color: var(--text-dim); }
        .cmd-item:hover, .cmd-item.selected { background: var(--highlight); color: var(--accent); }
        .cmd-shortcut { font-size: 10px; opacity: 0.5; font-family: sans-serif; background: var(--border); padding: 2px 6px; border-radius: 4px;}

        #toast {
            position: fixed; bottom: 32px; right: 12px; 
            background: var(--sidebar-bg); color: var(--text); border: 1px solid var(--accent);
            padding: 6px 12px; font-size: 11px; font-weight: 600; 
            border-radius: 4px; display: flex; align-items: center; gap: 8px;
            transform: translateY(10px); opacity: 0; pointer-events: none;
            transition: all 0.2s; z-index: 200; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        #toast.visible { transform: translateY(0); opacity: 1; pointer-events: auto; }
        #toast svg { color: var(--accent); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        ::-webkit-scrollbar-track { background: var(--bg); }

        /* Ace Tweaks */
        .ace_editor { font-family: var(--font-code) !important; line-height: 1.5 !important; }
        .ace_gutter { background: var(--sidebar-bg) !important; color: var(--text-dim) !important; }
        .ace_content { background: var(--bg) !important; }
        .ace_active-line { background: rgba(255,255,255,0.05) !important; }
    </style>
</head>
<body data-theme="mocha">

<header>
    <button class="btn" onclick="App.toggleSidebar()" title="Toggle Sidebar">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
    </button>
    <div class="logo">AETHER v3</div>
    
    <div class="toolbar">
        <div class="theme-swatches">
            <div class="theme-swatch swatch-latte" onclick="Config.setTheme('latte')" title="Latte"></div>
            <div class="theme-swatch swatch-frappe" onclick="Config.setTheme('frappe')" title="Frappe"></div>
            <div class="theme-swatch swatch-macchiato" onclick="Config.setTheme('macchiato')" title="Macchiato"></div>
            <div class="theme-swatch swatch-mocha" onclick="Config.setTheme('mocha')" title="Mocha"></div>
        </div>
        <div style="width:1px; height:16px; background:var(--border); margin:0 8px;"></div>
        <button class="btn" onclick="Commands.trigger('newFile')" title="New File (Alt+N)">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
        </button>
        <button class="btn" onclick="Commands.trigger('saveFile')" title="Save (Ctrl+S)">
            <svg class="icon" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></svg>
        </button>
        <div style="width:1px; height:16px; background:var(--border); margin:0 8px;"></div>
        <button class="btn primary" onclick="Commands.trigger('togglePreview')" title="Preview">
            <svg class="icon" viewBox="0 0 24 24"><path d="M5 12s2.545-5 7-5c4.454 0 7 5 7 5s-2.546 5-7 5c-4.455 0-7-5-7-5z"/><path d="M12 13a1 1 0 100-2 1 1 0 000 2z"/></svg>
        </button>
        <button class="btn" onclick="Commands.showPalette()" title="Commands (F1)">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
        </button>
    </div>
</header>

<div id="app-shell">
    <aside id="sidebar">
        <div class="side-header">
            <span>Workspace</span>
            <button class="btn" onclick="FileSys.openFolder()" title="Open Folder">
                <svg class="icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            </button>
        </div>
        <div id="file-tree" class="file-tree"></div>
        
        <div class="side-header" style="border-top:1px solid var(--border);">
            <span id="opfs-header">Local Storage</span>
            <div style="display:flex;">
                <button class="btn" onclick="FileSys.createOPFSFile()" title="New Local File">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                </button>
            </div>
        </div>
        <div id="opfs-tree" class="file-tree" style="max-height: 250px;"></div>
    </aside>

    <main>
        <div id="tabs-scroll"></div>
        <div class="breadcrumbs">
            <span>root</span><span>/</span><span id="bc-filename" style="color:var(--text)">[No Selection]</span>
        </div>
        
        <div id="editor-split">
            <div id="code-stage"></div>
            <div id="resizer"></div>
            <div id="preview-pane">
                <iframe id="preview-frame" sandbox="allow-scripts allow-modals allow-forms allow-same-origin"></iframe>
            </div>
        </div>
    </main>
</div>

<footer>
    <div class="stat-group">
        <span class="stat-box stat-primary">ACE</span>
        <span class="stat-box" id="stat-file">--</span>
    </div>
    <div class="stat-group">
        <span class="stat-box" id="stat-lang">TXT</span>
        <span class="stat-box" id="stat-pos">1:1</span>
        <span class="stat-box" id="stat-indent">Space: 4</span>
    </div>
</footer>

<div id="palette-mask" class="overlay-mask" onclick="if(event.target===this) Commands.hidePalette()">
    <div class="dialog">
        <input type="text" id="cmd-input" placeholder="> Type a command..." autocomplete="off">
        <div id="cmd-list" style="max-height: 350px; overflow-y: auto;"></div>
    </div>
</div>

<div id="prompt-mask" class="overlay-mask">
    <div class="dialog">
        <div style="padding:10px 16px; font-weight:800; background:var(--header-bg); color:var(--text); border-bottom:1px solid var(--border); font-size:10px; text-transform:uppercase;" id="prompt-msg">Input</div>
        <input type="text" id="prompt-input" autocomplete="off" style="background:var(--bg)">
        <div style="display:flex; padding:8px; gap:8px; background: var(--header-bg); justify-content: flex-end;">
            <button class="btn" style="width:auto; padding:0 8px; font-size:10px;" onclick="Prompt.close()">Cancel</button>
            <button class="btn primary" style="width:auto; padding:0 8px; font-size:10px;" id="prompt-ok">Submit</button>
        </div>
    </div>
</div>

<div id="confirm-mask" class="overlay-mask">
    <div class="dialog">
        <div style="padding:10px 16px; font-weight:800; background:var(--header-bg); color:var(--text); border-bottom:1px solid var(--border); font-size:10px; text-transform:uppercase;" id="confirm-title">Confirmation</div>
        <div style="padding:20px 16px; color:var(--text); font-size:12px;" id="confirm-msg">Are you sure?</div>
        <div style="display:flex; padding:8px; gap:8px; background: var(--header-bg); justify-content: flex-end;">
            <button class="btn" style="width:auto; padding:0 8px; font-size:10px;" onclick="Confirm.close()">Cancel</button>
            <button class="btn primary" style="width:auto; padding:0 8px; font-size:10px; color:#ff8888;" id="confirm-ok">Confirm</button>
        </div>
    </div>
</div>

<div id="toast">
    <svg class="icon" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
    <span id="toast-msg">Initialized</span>
</div>

<script>
/**
 * AETHER v3 - Final Polish
 */

const Config = {
    defaults: { theme: 'mocha', fontSize: 13, sidebarWidth: 220, wordWrap: true },
    state: {},
    init() {
        try { this.state = { ...this.defaults, ...JSON.parse(localStorage.getItem('aether_config') || '{}') }; } 
        catch (e) { this.state = { ...this.defaults }; }
        this.apply();
    },
    save() { localStorage.setItem('aether_config', JSON.stringify(this.state)); this.apply(); },
    setTheme(name) { this.state.theme = name; this.save(); },
    toggleWrap() { this.state.wordWrap = !this.state.wordWrap; this.save(); UI.toast(`Word Wrap: ${this.state.wordWrap ? 'ON' : 'OFF'}`); },
    zoom(delta) { this.state.fontSize = Math.max(10, Math.min(24, this.state.fontSize + delta)); this.save(); UI.toast(`Zoom: ${this.state.fontSize}px`); },
    apply() {
        document.body.setAttribute('data-theme', this.state.theme);
        document.documentElement.style.setProperty('--sidebar-w', this.state.sidebarWidth + 'px');
        if (Editor.instance) {
            Editor.instance.setFontSize(this.state.fontSize);
            Editor.instance.setOption("wrap", this.state.wordWrap);
            Editor.instance.setTheme(this.state.theme === 'latte' ? 'ace/theme/chrome' : 'ace/theme/tomorrow_night_eighties');
        }
    }
};

const Store = {
    state: { buffers: [], activeId: null, opfsRoot: null, previewMode: false },
    get activeBuffer() { return this.state.buffers.find(b => b.id === this.state.activeId); },
    addBuffer(b) { this.state.buffers.push(b); this.setActive(b.id); App.saveSession(); },
    closeBuffer(id) {
        const idx = this.state.buffers.findIndex(b => b.id === id);
        if (idx === -1) return;
        this.state.buffers.splice(idx, 1);
        if (this.state.activeId === id) {
            const next = this.state.buffers[idx] || this.state.buffers[idx - 1];
            this.setActive(next ? next.id : null);
        } else UI.renderTabs();
        App.saveSession();
    },
    setActive(id) { 
        this.state.activeId = id; UI.renderTabs();
        const buf = this.activeBuffer;
        if (buf) { Editor.load(buf.content, buf.name); document.getElementById('bc-filename').innerText = buf.name; } 
        else { Editor.load('', 'txt'); document.getElementById('bc-filename').innerText = '[No Selection]'; }
        App.saveSession(); 
    },
    updateContent(id, c) { const b = this.state.buffers.find(b => b.id === id); if(b && b.content !== c) { b.content = c; if(!b.dirty) { b.dirty = true; UI.renderTabs(); } } },
    markSaved(id) { const b = this.state.buffers.find(b => b.id === id); if(b) { b.dirty = false; UI.renderTabs(); } }
};

const Editor = {
    instance: null,
    init() {
        this.instance = ace.edit("code-stage");
        this.instance.setOptions({
            enableBasicAutocompletion: true, enableLiveAutocompletion: true,
            showPrintMargin: false, useSoftTabs: true, tabSize: 4,
            fontSize: Config.state.fontSize, fontFamily: 'JetBrains Mono, monospace', scrollPastEnd: 0.5
        });
        this.instance.on('change', () => { if (Store.state.activeId) Store.updateContent(Store.state.activeId, this.instance.getValue()); App.debouncePreview(); });
        this.instance.on('changeSelection', () => App.updateStats());
        // Shortcuts
        this.instance.commands.addCommand({ name: 'save', bindKey: {win: 'Ctrl-S', mac: 'Command-S'}, exec: () => Commands.trigger('saveFile') });
        this.instance.commands.addCommand({ name: 'palette', bindKey: {win: 'F1|Ctrl-P', mac: 'F1|Command-P'}, exec: () => Commands.showPalette() });
        this.instance.commands.addCommand({ name: 'new', bindKey: {win: 'Alt-N', mac: 'Option-N'}, exec: () => Commands.trigger('newFile') });
        this.instance.commands.addCommand({ name: 'closeTab', bindKey: {win: 'Alt-W', mac: 'Option-W'}, exec: () => Commands.trigger('closeTab') });
    },
    load(content, filename) {
        if (this.instance.getValue() !== content) this.instance.setValue(content, -1);
        const ext = filename ? filename.split('.').pop().toLowerCase() : 'txt';
        const modes = { js:'javascript', ts:'javascript', html:'html', css:'css', py:'python', md:'markdown', json:'javascript' };
        this.instance.session.setMode(`ace/mode/${modes[ext] || 'text'}`);
        this.instance.session.getUndoManager().reset();
        App.updateStats(); App.debouncePreview(true);
    }
};

const FileSys = {
    async initOPFS() {
        try {
            if (!navigator.storage?.getDirectory) throw 1;
            Store.state.opfsRoot = await navigator.storage.getDirectory();
            this.renderOPFS();
        } catch (e) { document.getElementById('opfs-header').innerText = "LocalStorage Only"; }
    },
    async renderOPFS() {
        if (!Store.state.opfsRoot) return;
        const div = document.getElementById('opfs-tree');
        div.innerHTML = '';
        for await (const [name, handle] of Store.state.opfsRoot.entries()) {
            if (handle.kind === 'file') {
                const el = document.createElement('div');
                el.className = 'tree-item';
                const label = document.createElement('span');
                label.className = 'tree-item-label';
                label.innerHTML = `<svg class="icon" style="width:12px;" viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg> ${name}`;
                label.onclick = async () => App.openBuffer(name, await (await handle.getFile()).text(), handle, 'opfs');
                
                const actions = document.createElement('div');
                actions.className = 'tree-actions';
                
                // Rename Btn
                const renBtn = document.createElement('span');
                renBtn.className = 'action-btn';
                renBtn.title = "Rename";
                renBtn.innerHTML = `<svg class="icon" style="width:12px;height:12px;" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                renBtn.onclick = (e) => { e.stopPropagation(); this.renameOPFSFile(name, handle); };

                // Delete Btn
                const delBtn = document.createElement('span');
                delBtn.className = 'action-btn action-delete';
                delBtn.title = "Delete";
                delBtn.innerHTML = `<svg class="icon" style="width:12px;height:12px;" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                delBtn.onclick = (e) => { e.stopPropagation(); this.deleteOPFSFile(name); };

                actions.append(renBtn, delBtn);
                el.append(label, actions);
                div.appendChild(el);
            }
        }
    },
    async createOPFSFile() {
        Prompt.open("New Local File:", "script.js", async (name) => {
            if(!name) return;
            try {
                const handle = await Store.state.opfsRoot.getFileHandle(name, { create: true });
                App.openBuffer(name, "", handle, 'opfs');
                this.renderOPFS();
            } catch (e) { UI.toast('Error creating file'); }
        });
    },
    async renameOPFSFile(oldName, handle) {
        Prompt.open(`Rename "${oldName}" to:`, oldName, async (newName) => {
            if (!newName || newName === oldName) return;
            try {
                // OPFS rename polyfill: Copy -> Delete -> Create
                const file = await handle.getFile();
                const content = await file.text();
                const newHandle = await Store.state.opfsRoot.getFileHandle(newName, { create: true });
                const writable = await newHandle.createWritable();
                await writable.write(content);
                await writable.close();
                await Store.state.opfsRoot.removeEntry(oldName);
                
                // Update open buffers
                const buf = Store.state.buffers.find(b => b.name === oldName && b.kind === 'opfs');
                if (buf) { buf.name = newName; buf.handle = newHandle; UI.renderTabs(); document.getElementById('bc-filename').innerText = newName; }
                
                this.renderOPFS();
                UI.toast('Renamed');
            } catch(e) { UI.toast('Rename Failed'); }
        });
    },
    async deleteOPFSFile(name) {
        Confirm.open("Delete File", `Permanently delete "${name}"?`, async () => {
            try {
                await Store.state.opfsRoot.removeEntry(name);
                const buf = Store.state.buffers.find(b => b.name === name && b.kind === 'opfs');
                if (buf) App.closeBuffer(buf.id);
                this.renderOPFS();
                UI.toast('Deleted');
            } catch (e) { UI.toast('Delete failed'); }
        });
    },
    async saveBuffer(buf) {
        if (buf.name === 'config.json' && buf.kind === 'config') { Config.state = JSON.parse(buf.content); Config.save(); Store.markSaved(buf.id); return; }
        try {
            let handle = buf.handle;
            if (!handle && buf.kind === 'memory') {
                handle = await window.showSaveFilePicker({ suggestedName: buf.name });
                buf.handle = handle; buf.kind = 'disk'; buf.name = handle.name;
            }
            const writable = await handle.createWritable();
            await writable.write(buf.content);
            await writable.close();
            Store.markSaved(buf.id);
            UI.toast(`Saved: ${buf.name}`);
        } catch (e) { UI.toast('Save Cancelled'); }
    }
};

const App = {
    init() {
        Editor.init(); Config.init(); FileSys.initOPFS(); Resizer.init();
        const saved = JSON.parse(localStorage.getItem('aether_v3_session') || '[]');
        if (saved.length) saved.forEach(s => this.openBuffer(s.name, s.content, null, 'memory'));
        else this.openBuffer('welcome.md', "# Aether v3 - Final\n\n- **Drag & Drop** files to open\n- **Renaming** for local files\n- **Shortcuts:**\n  - F1: Palette\n  - Alt+N: New File\n  - Alt+W: Close Tab", null, 'memory');
        
        // Drag & Drop
        document.body.addEventListener('dragover', e => { e.preventDefault(); document.body.classList.add('drag-over'); });
        document.body.addEventListener('dragleave', e => { if(e.relatedTarget === null) document.body.classList.remove('drag-over'); });
        document.body.addEventListener('drop', async e => {
            e.preventDefault(); document.body.classList.remove('drag-over');
            for (const item of e.dataTransfer.items) {
                if (item.kind === 'file') {
                    const file = item.getAsFile();
                    this.openBuffer(file.name, await file.text(), null, 'memory');
                }
            }
        });
        
        new ResizeObserver(() => Editor.instance.resize()).observe(document.querySelector('main'));
    },
    openBuffer(name, content, handle, kind) {
        const existing = Store.state.buffers.find(b => b.name === name);
        if (existing) return Store.setActive(existing.id);
        Store.addBuffer({ id: 'b'+Date.now(), name, content, handle, kind, dirty: false });
    },
    updateStats() {
        if (!Editor.instance) return;
        const pos = Editor.instance.getCursorPosition();
        document.getElementById('stat-pos').innerText = `${pos.row + 1}:${pos.column + 1}`;
        const buf = Store.activeBuffer;
        if(buf) {
            document.getElementById('stat-file').innerText = buf.name;
            document.getElementById('stat-lang').innerText = buf.name.split('.').pop().toUpperCase();
        }
    },
    debouncePreview(immediate) {
        if (!Store.state.previewMode) return;
        clearTimeout(this.pvTimer);
        const run = () => {
            const buf = Store.activeBuffer; if (!buf) return;
            const f = document.getElementById('preview-frame');
            const ext = buf.name.split('.').pop().toLowerCase();
            const styles = getComputedStyle(document.body);
            const baseCss = `body{background:${styles.getPropertyValue('--bg')};color:${styles.getPropertyValue('--text')};font-family:sans-serif;padding:20px;line-height:1.6;}a{color:${styles.getPropertyValue('--accent')}}pre{background:rgba(0,0,0,0.2);padding:10px;border-radius:4px;overflow:auto}code{font-family:'JetBrains Mono',monospace;font-size:0.9em}blockquote{border-left:3px solid ${styles.getPropertyValue('--accent')};padding-left:1em;color:${styles.getPropertyValue('--text-dim')}}`;
            let html = "";
            if (ext === 'md') html = `<style>${baseCss}</style>` + marked.parse(buf.content);
            else if (ext === 'html') html = buf.content;
            else html = `<style>${baseCss}</style><pre>${buf.content.replace(/</g,'&lt;')}</pre>`;
            f.srcdoc = html;
        };
        if(immediate) run(); else this.pvTimer = setTimeout(run, 500);
    },
    toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); },
    saveSession() { localStorage.setItem('aether_v3_session', JSON.stringify(Store.state.buffers.filter(b => b.kind !== 'config').map(b => ({name:b.name, content:b.content})))); }
};

const UI = {
    renderTabs() {
        const con = document.getElementById('tabs-scroll'); con.innerHTML = '';
        Store.state.buffers.forEach(b => {
            const el = document.createElement('div');
            el.className = `tab ${b.id === Store.state.activeId ? 'active' : ''} ${b.dirty ? 'dirty' : ''}`;
            el.innerHTML = `<span>${b.name}</span><span class="unsaved-dot"></span><div class="tab-close" onclick="event.stopPropagation(); Store.closeBuffer('${b.id}')">Ã—</div>`;
            el.onclick = () => Store.setActive(b.id);
            con.appendChild(el);
            if(b.id === Store.state.activeId) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
    },
    toast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('visible'); clearTimeout(this.toastTimer); this.toastTimer = setTimeout(() => t.classList.remove('visible'), 2500); }
};

const Commands = {
    list: [
        { id: 'newFile', name: 'New File', hint: 'Alt+N', fn: () => Prompt.open("Filename:", "untitled.js", (n) => App.openBuffer(n, "", null, 'memory')) },
        { id: 'saveFile', name: 'Save File', hint: 'Ctrl+S', fn: () => Store.activeBuffer && FileSys.saveBuffer(Store.activeBuffer) },
        { id: 'closeTab', name: 'Close Tab', hint: 'Alt+W', fn: () => Store.activeBuffer && Store.closeBuffer(Store.activeBuffer.id) },
        { id: 'togglePreview', name: 'Toggle Preview', hint: 'UI', fn: () => { Store.state.previewMode = !Store.state.previewMode; document.body.classList.toggle('preview-active', Store.state.previewMode); App.debouncePreview(true); setTimeout(() => Editor.instance.resize(), 300); }},
        { id: 'settings', name: 'Edit Settings', hint: 'JSON', fn: () => App.openBuffer('config.json', JSON.stringify(Config.state, null, 4), null, 'config') },
        { id: 'wrap', name: 'Toggle Word Wrap', hint: 'View', fn: () => Config.toggleWrap() },
        { id: 'clear', name: 'Reset App', hint: 'Danger', fn: () => { localStorage.removeItem('aether_v3_session'); location.reload(); } }
    ],
    trigger(id) { const c = this.list.find(c => c.id === id); if(c) c.fn(); },
    showPalette() {
        const mask = document.getElementById('palette-mask'); const list = document.getElementById('cmd-list'); list.innerHTML = '';
        this.list.forEach((cmd, idx) => {
            const el = document.createElement('div'); el.className = 'cmd-item'; if(idx===0) el.classList.add('selected');
            el.innerHTML = `<span>${cmd.name}</span><span class="cmd-shortcut">${cmd.hint}</span>`;
            el.onclick = () => { cmd.fn(); this.hidePalette(); }; list.appendChild(el);
        });
        mask.style.display = 'flex'; document.getElementById('cmd-input').value = ''; document.getElementById('cmd-input').focus();
    },
    hidePalette() { document.getElementById('palette-mask').style.display = 'none'; Editor.instance.focus(); }
};

const Prompt = {
    open(msg, def, cb) {
        document.getElementById('prompt-mask').style.display = 'flex'; document.getElementById('prompt-msg').innerText = msg;
        const inp = document.getElementById('prompt-input'); inp.value = def; inp.focus(); inp.select();
        const sub = () => { if(inp.value) cb(inp.value); this.close(); };
        document.getElementById('prompt-ok').onclick = sub; inp.onkeydown = (e) => { if(e.key==='Enter') sub(); if(e.key==='Escape') this.close(); };
    },
    close() { document.getElementById('prompt-mask').style.display = 'none'; Editor.instance.focus(); }
};

const Confirm = {
    open(title, msg, onYes) {
        document.getElementById('confirm-mask').style.display = 'flex'; document.getElementById('confirm-title').innerText = title;
        document.getElementById('confirm-msg').innerText = msg; document.getElementById('confirm-ok').onclick = () => { onYes(); this.close(); };
        document.querySelector('#confirm-mask .btn').focus();
    },
    close() { document.getElementById('confirm-mask').style.display = 'none'; Editor.instance.focus(); }
};

const Resizer = {
    init() {
        const r = document.getElementById('resizer'); const p = document.getElementById('preview-pane'); let isResizing = false;
        r.onmousedown = (e) => { isResizing = true; r.classList.add('active'); document.body.classList.add('resizing'); e.preventDefault(); };
        document.onmousemove = (e) => {
            if (!isResizing) return;
            const w = document.getElementById('editor-split').offsetWidth;
            const pW = 100 - ((e.clientX - document.getElementById('sidebar').offsetWidth) / w * 100);
            if (pW > 10 && pW < 90) { p.style.width = pW + '%'; Editor.instance.resize(); }
        };
        document.onmouseup = () => { if(isResizing) { isResizing = false; r.classList.remove('active'); document.body.classList.remove('resizing'); Editor.instance.resize(); }};
    }
};

window.onload = () => App.init();
</script>
</body>
</html>
