<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#050508">
    <title>Aether v3 Pro</title>
    
    <!-- Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            /* Deeper, more minimal obsidian palette */
            --bg: #050508; 
            --mantle: #0a0a0f; 
            --crust: #030305;
            --text: #e0e0e6; 
            --subtext: #9494a0; 
            --overlay: #5a5a66;
            --surface: #14141d; 
            --surface-hover: #1c1c27;
            --base: #0a0a0f;
            --blue: #4cc2ff; 
            --lavender: #99adff; 
            --red: #ff5d8f;
            --green: #4ade80; 
            --yellow: #facc15;
            
            --font-code: 'JetBrains Mono', 'Fira Code', 'Menlo', 'Monaco', monospace;
            --font-ui: "Inter", -apple-system, system-ui, sans-serif;
            
            --header-h: 44px;
            --footer-h: 22px;
            --sidebar-w: 250px;
            --tab-h: 34px;
            --radius: 4px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background: var(--bg); color: var(--text);
            height: 100dvh; width: 100vw; overflow: hidden;
            font-family: var(--font-ui); display: flex; flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        svg.icon { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        /* --- Layout --- */
        #app-shell { display: flex; flex: 1; overflow: hidden; }
        
        aside {
            width: var(--sidebar-w); background: var(--crust); border-right: 1px solid var(--surface);
            display: flex; flex-direction: column; transition: transform 0.3s cubic-bezier(0.2, 1, 0.2, 1);
            z-index: 10; flex-shrink: 0;
        }
        aside.collapsed { margin-left: calc(var(--sidebar-w) * -1); }
        
        .side-header { 
            padding: 14px 16px 6px 16px; font-size: 0.65rem; font-weight: 700; 
            color: var(--overlay); text-transform: uppercase; letter-spacing: 1px; 
            display:flex; justify-content: space-between; align-items: center; 
        }
        .file-tree { flex: 1; overflow-y: auto; padding: 4px 10px; }
        .tree-item {
            padding: 5px 10px; font-size: 0.8rem; color: var(--subtext); cursor: pointer;
            display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden; 
            text-overflow: ellipsis; border-radius: var(--radius); transition: 0.1s;
            margin-bottom: 1px;
        }
        .tree-item:hover { background: var(--surface); color: var(--text); }
        .tree-item.active { background: var(--surface-hover); color: var(--blue); }

        /* Main Area */
        main { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; background: var(--base); }

        /* Tabs */
        #tabs-scroll { 
            height: var(--tab-h); background: var(--crust); display: flex; 
            overflow-x: auto; scrollbar-width: none; border-bottom: 1px solid var(--surface);
            gap: 1px; padding: 0 4px;
        }
        #tabs-scroll::-webkit-scrollbar { display: none; }
        
        .tab {
            height: 100%; padding: 0 12px; display: flex; align-items: center; gap: 10px;
            color: var(--overlay); font-size: 0.75rem; cursor: pointer; 
            transition: 0.2s; min-width: 110px; max-width: 180px; position: relative;
            border-bottom: 1px solid transparent;
        }
        .tab:hover { color: var(--subtext); background: var(--surface); }
        .tab.active { background: var(--base); color: var(--blue); border-bottom-color: var(--blue); }
        
        .tab-close { opacity: 0; border-radius: 3px; padding: 2px; font-size: 9px; line-height: 1; }
        .tab:hover .tab-close { opacity: 0.6; }
        .tab-close:hover { background: var(--red); color: var(--crust); opacity: 1 !important; }
        .unsaved-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--yellow); display: none; }
        .tab.dirty .unsaved-dot { display: block; }
        .tab.dirty .tab-close { display: none; }
        .tab.dirty:hover .unsaved-dot { display: none; }
        .tab.dirty:hover .tab-close { display: block; }

        /* Breadcrumbs (Studio Logic) */
        .breadcrumbs {
            height: 26px; background: var(--base); border-bottom: 1px solid var(--surface);
            display: flex; align-items: center; padding: 0 16px; gap: 8px;
            font-size: 10px; color: var(--overlay); text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* Editor Wrapper */
        #editor-split { flex: 1; display: flex; overflow: hidden; position: relative; }
        #code-stage { flex: 1; position: relative; overflow: hidden; background: var(--base); }
        
        .code-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            margin: 0; border: none; background: transparent;
            font-family: var(--font-code) !important; 
            font-size: 14px !important; 
            line-height: 21px !important;
            white-space: pre !important; 
            padding: 12px 0 12px 50px !important; 
            box-sizing: border-box;
        }

        #hl-layer { z-index: 1; pointer-events: none; }
        #hl-layer code, #hl-layer pre { 
            font-family: inherit !important; font-size: inherit !important; line-height: inherit !important;
            white-space: pre !important; padding: 0 !important; margin: 0 !important;
            background: transparent !important; border: none !important; box-shadow: none !important;
        }

        #input-layer {
            z-index: 2; color: transparent; caret-color: var(--blue);
            outline: none; resize: none; overflow: auto; 
        }
        #input-layer::selection { background: rgba(76, 194, 255, 0.2); }

        #gutter {
            width: 44px; background: var(--crust); color: var(--overlay);
            text-align: right; padding: 12px 10px 12px 0; border-right: 1px solid var(--surface);
            z-index: 5; user-select: none; opacity: 0.5;
            font-family: var(--font-code); font-size: 11px; line-height: 21px;
            overflow: hidden; 
        }
        #gutter .active-line { background: var(--surface); color: var(--blue); opacity: 1; font-weight: 700; border-radius: 2px; }

        /* Preview Pane */
        #preview-pane { 
            width: 0; border-left: 1px solid var(--surface); background: #fff; 
            display: flex; flex-direction: column; overflow: hidden;
            transition: width 0.3s cubic-bezier(0.2, 1, 0.2, 1);
        }
        .preview-active #preview-pane { width: 45%; }
        iframe { width: 100%; height: 100%; border: none; }
        
        #resizer { 
            width: 2px; background: transparent; cursor: col-resize; position: absolute; right: 0; top: 0; bottom: 0; z-index: 25;
            display: none; transition: background 0.2s;
        }
        #resizer:hover { background: var(--blue); }
        .preview-active #code-stage #resizer { display: block; }

        /* Header & Footer */
        header {
            height: var(--header-h); background: var(--crust); border-bottom: 1px solid var(--surface);
            display: flex; align-items: center; padding: 0 12px; gap: 6px;
        }
        .logo { font-weight: 900; color: var(--text); letter-spacing: 1px; margin-right: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }
        .logo span { color: var(--blue); }
        
        footer {
            height: var(--footer-h); background: var(--crust); border-top: 1px solid var(--surface);
            display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
            font-size: 9px; color: var(--overlay); font-weight: 600; text-transform: uppercase;
        }

        /* Buttons */
        .btn {
            background: transparent; border: 1px solid transparent; color: var(--overlay);
            padding: 4px 8px; border-radius: var(--radius); font-size: 11px; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: 0.1s; font-weight: 600;
        }
        .btn:hover { background: var(--surface); color: var(--text); }
        .btn.primary { background: var(--surface); border-color: var(--surface-hover); color: var(--blue); }
        .btn.icon-only { padding: 6px; }
        
        .spacer { flex: 1; }

        /* Command Palette */
        .overlay-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100;
            display: none; align-items: flex-start; justify-content: center; padding-top: 10vh;
            backdrop-filter: blur(10px);
        }
        .dialog {
            background: var(--mantle); border: 1px solid var(--surface-hover); width: 600px;
            border-radius: 8px; overflow: hidden; box-shadow: 0 40px 100px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
        }

        .dialog input {
            background: transparent; border: none; color: var(--text); padding: 20px;
            font-size: 15px; width: 100%; border-bottom: 1px solid var(--surface);
        }
        .cmd-item { padding: 10px 20px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .cmd-item:hover, .cmd-item.selected { background: var(--blue); color: var(--bg); }
        .cmd-hint { font-size: 10px; opacity: 0.7; font-weight: 700; text-transform: uppercase; }

        /* Toast */
        #toast {
            position: fixed; bottom: 34px; right: 16px; background: var(--blue); color: var(--crust);
            padding: 8px 16px; border-radius: 4px; font-size: 11px; font-weight: 800;
            transform: translateY(100px); transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #toast.visible { transform: translateY(0); }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--surface-hover); border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <button class="btn icon-only" onclick="App.toggleSidebar()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
    </button>
    <div class="logo">AETHER<span>PRO</span></div>
    
    <button class="btn" onclick="Commands.trigger('newFile')">NEW</button>
    <button class="btn" onclick="Commands.trigger('openFile')">OPEN</button>
    <button class="btn" onclick="Commands.trigger('saveFile')">SAVE</button>
    
    <div class="spacer"></div>
    
    <button class="btn primary" onclick="Commands.trigger('togglePreview')">
        <svg class="icon" viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
        PREVIEW
    </button>
    <button class="btn icon-only" onclick="Commands.showPalette()">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
    </button>
</header>

<div id="app-shell">
    <aside id="sidebar">
        <div class="side-header">
            <span>Workspace</span>
            <button class="btn icon-only" onclick="Commands.trigger('openFolder')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            </button>
        </div>
        <div id="file-tree" class="file-tree"></div>
        
        <div class="side-header" style="border-top:1px solid var(--surface); padding-top:14px;">
            <span id="opfs-header">Local (OPFS)</span>
            <div style="display:flex; gap:2px">
                <button class="btn icon-only" onclick="FileSys.createOPFSFile()" title="New OPFS File">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                </button>
                <button class="btn icon-only" onclick="FileSys.initOPFS()" title="Refresh OPFS">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                </button>
            </div>
        </div>
        <div id="opfs-tree" class="file-tree" style="max-height: 220px;"></div>
    </aside>

    <main>
        <div id="tabs-scroll"></div>
        <div class="breadcrumbs" id="breadcrumb-bar">
            <span>root</span>
            <span>/</span>
            <span id="bc-filename">--</span>
        </div>

        <div id="editor-split">
            <div id="code-stage">
                <div id="gutter"></div>
                <div id="hl-layer" class="code-layer"><code id="hl-code" class="language-javascript"></code></div>
                <textarea id="input-layer" class="code-layer" spellcheck="false" wrap="off"></textarea>
                <div id="resizer"></div>
            </div>
            
            <div id="preview-pane">
                <iframe id="preview-frame" sandbox="allow-scripts allow-modals allow-forms"></iframe>
            </div>
        </div>
    </main>
</div>

<footer>
    <div style="display:flex; gap:24px;">
        <span id="stat-file">--</span>
        <span id="stat-lang">PLAIN TEXT</span>
    </div>
    <div style="display:flex; gap:24px;">
        <span id="stat-pos">LN 1, COL 1</span>
        <span id="stat-space">UTF-8</span>
    </div>
</footer>

<div id="palette-mask" class="overlay-mask" onclick="if(event.target===this) Commands.hidePalette()">
    <div class="dialog">
        <input type="text" id="cmd-input" placeholder="Search commands..." autocomplete="off">
        <div id="cmd-list" style="max-height: 320px; overflow-y: auto;"></div>
    </div>
</div>

<div id="prompt-mask" class="overlay-mask">
    <div class="dialog">
        <div style="padding:16px 20px; font-size:10px; font-weight:800; background:var(--crust); color:var(--overlay);" id="prompt-msg">ACTION REQUIRED</div>
        <input type="text" id="prompt-input" autocomplete="off">
        <div style="display:flex; padding:12px; gap:8px; background: var(--crust)">
            <button class="btn" onclick="Prompt.close()" style="flex:1; justify-content:center;">CANCEL</button>
            <button class="btn primary" id="prompt-ok" style="flex:1; justify-content:center;">CONTINUE</button>
        </div>
    </div>
</div>

<div id="toast">Operation Successful</div>

<script>
/**
 * AETHER v3 Pro - Obsidian Edition
 * Studio-grade minimalist logic with persistent OPFS and high-density UI
 */

const Store = {
    state: {
        buffers: [],
        activeId: null,
        workspace: null,
        opfsRoot: null,
        previewMode: false
    },
    subs: [],
    
    get activeBuffer() { return this.state.buffers.find(b => b.id === this.state.activeId); },
    subscribe(fn) { this.subs.push(fn); },
    notify(event) { this.subs.forEach(fn => fn(event, this.state)); },
    
    addBuffer(buffer) {
        this.state.buffers.push(buffer);
        this.state.activeId = buffer.id;
        this.notify('buffer_added');
        App.saveSession();
    },
    
    closeBuffer(id) {
        const idx = this.state.buffers.findIndex(b => b.id === id);
        if (idx === -1) return;
        this.state.buffers.splice(idx, 1);
        if (this.state.activeId === id) {
            this.state.activeId = this.state.buffers.length ? this.state.buffers[Math.max(0, idx - 1)].id : null;
        }
        this.notify('buffer_closed');
        App.saveSession();
    },
    
    setActive(id) {
        if (this.state.activeId === id) return;
        this.state.activeId = id;
        this.notify('buffer_switched');
        App.saveSession();
    },
    
    updateContent(id, content) {
        const b = this.state.buffers.find(b => b.id === id);
        if (b && b.content !== content) {
            b.content = content;
            if (!b.dirty) { b.dirty = true; this.notify('buffer_dirty'); }
        }
    },
    
    markSaved(id) {
        const b = this.state.buffers.find(b => b.id === id);
        if (b) { b.dirty = false; this.notify('buffer_saved'); }
    }
};

const Editor = {
    els: {
        input: document.getElementById('input-layer'),
        hl: document.getElementById('hl-code'),
        hlLayer: document.getElementById('hl-layer'),
        gutter: document.getElementById('gutter')
    },

    init() {
        this.els.input.addEventListener('scroll', () => {
            requestAnimationFrame(() => {
                this.els.hlLayer.scrollTop = this.els.input.scrollTop;
                this.els.hlLayer.scrollLeft = this.els.input.scrollLeft;
                this.els.gutter.scrollTop = this.els.input.scrollTop;
            });
        }, { passive: true });

        this.els.input.addEventListener('input', () => {
            const val = this.els.input.value;
            if (Store.state.activeId) Store.updateContent(Store.state.activeId, val);
            this.highlight(val);
            this.updateGutter(val);
            App.debouncePreview();
        });

        this.els.input.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                document.execCommand('insertText', false, '    ');
            }
            setTimeout(() => App.updateStats(), 0);
        });

        this.els.input.addEventListener('click', () => App.updateStats());
    },

    load(content, filename) {
        this.els.input.value = content;
        this.highlight(content, filename);
        this.updateGutter(content);
        this.els.input.scrollTop = 0;
        App.updateStats();
        App.debouncePreview(true);
    },

    highlight(code, filename) {
        const buf = Store.activeBuffer;
        const name = filename || (buf ? buf.name : 'txt');
        const ext = name.split('.').pop().toLowerCase();
        const map = {
            'js': 'javascript', 'ts': 'javascript', 'py': 'python', 
            'html': 'markup', 'css': 'css', 'json': 'json', 'md': 'markdown'
        };
        const lang = map[ext] || 'clike';
        this.els.hl.className = `language-${lang}`;
        if (Prism.languages[lang]) {
            this.els.hl.innerHTML = Prism.highlight(code, Prism.languages[lang], lang) + '<br>'; 
        } else {
            this.els.hl.innerHTML = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") + '<br>';
        }
    },

    updateGutter(text) {
        const lines = text.split('\n').length;
        const currentLine = this.els.input.value.substring(0, this.els.input.selectionStart).split('\n').length;
        let html = '';
        for (let i = 1; i <= lines; i++) {
            const active = i === currentLine ? 'active-line' : '';
            html += `<div class="${active}">${i}</div>`;
        }
        this.els.gutter.innerHTML = html;
    }
};

const FileSys = {
    async initOPFS() {
        try {
            if (!navigator.storage?.getDirectory) throw 1;
            Store.state.opfsRoot = await navigator.storage.getDirectory();
            this.renderOPFS();
            UI.toast('OPFS Mounted');
        } catch (e) { 
            document.getElementById('opfs-header').innerText = "MEMORY-STORAGE ONLY";
        }
    },

    async renderOPFS() {
        if (!Store.state.opfsRoot) return;
        const div = document.getElementById('opfs-tree');
        div.innerHTML = '';
        for await (const [name, handle] of Store.state.opfsRoot.entries()) {
            if (handle.kind === 'file') {
                const el = document.createElement('div');
                el.className = 'tree-item';
                el.innerHTML = `ðŸ“„ ${name}`;
                el.onclick = async () => {
                    const file = await handle.getFile();
                    App.openBuffer(name, await file.text(), handle, 'opfs');
                };
                div.appendChild(el);
            }
        }
    },

    async createOPFSFile() {
        if (!Store.state.opfsRoot) return;
        Prompt.open("NEW OPFS FILENAME:", "script.js", async (name) => {
            try {
                const handle = await Store.state.opfsRoot.getFileHandle(name, { create: true });
                App.openBuffer(name, "", handle, 'opfs');
                this.renderOPFS();
                UI.toast(`Created ${name}`);
            } catch (e) { UI.toast('Failed to create file', true); }
        });
    },

    async saveToOPFS(buf) {
        if (!Store.state.opfsRoot) { UI.toast('OPFS unavailable', true); return; }
        try {
            const handle = await Store.state.opfsRoot.getFileHandle(buf.name, { create: true });
            const writable = await handle.createWritable();
            await writable.write(buf.content);
            await writable.close();
            buf.handle = handle;
            buf.kind = 'opfs';
            Store.markSaved(buf.id);
            this.renderOPFS();
            UI.renderTabs();
            UI.toast('Saved to OPFS');
        } catch (e) { UI.toast('OPFS Write Error', true); }
    },

    async openDiskFile() {
        try {
            const [handle] = await window.showOpenFilePicker();
            const file = await handle.getFile();
            App.openBuffer(file.name, await file.text(), handle, 'disk');
        } catch (e) {}
    },

    async openFolder() {
        try {
            const handle = await window.showDirectoryPicker();
            this.renderWorkspace(handle);
        } catch(e) {}
    },

    async renderWorkspace(dirHandle, parentEl = document.getElementById('file-tree'), level = 0) {
        if(level === 0) parentEl.innerHTML = '';
        for await (const [name, handle] of dirHandle.entries()) {
            const el = document.createElement('div');
            el.className = 'tree-item';
            el.style.paddingLeft = `${(level * 6) + 10}px`;
            el.innerHTML = `${handle.kind === 'directory' ? 'ðŸ“' : 'ðŸ“„'} ${name}`;
            if (handle.kind === 'file') {
                el.onclick = async () => App.openBuffer(name, await (await handle.getFile()).text(), handle, 'disk');
            }
            parentEl.appendChild(el);
        }
    },

    async saveBuffer(buf) {
        try {
            if (!buf.handle) {
                buf.handle = await window.showSaveFilePicker({ suggestedName: buf.name });
                buf.name = buf.handle.name;
            }
            const writable = await buf.handle.createWritable();
            await writable.write(buf.content);
            await writable.close();
            Store.markSaved(buf.id);
            UI.toast(`Saved ${buf.name}`);
        } catch (e) { UI.toast('Save Interrupted', true); }
    }
};

const App = {
    init() {
        Store.subscribe((event) => {
            if (['buffer_added', 'buffer_closed', 'buffer_switched'].includes(event)) {
                UI.renderTabs();
                const buf = Store.activeBuffer;
                Editor.load(buf?.content || '', buf?.name || 'txt');
                document.getElementById('bc-filename').innerText = buf?.name || '--';
            }
            if (event === 'buffer_dirty') UI.renderTabs();
        });

        const saved = JSON.parse(localStorage.getItem('aether_v3_session') || '[]');
        if (saved.length) saved.forEach(s => this.openBuffer(s.name, s.content, null, 'memory'));
        else this.openBuffer('getting_started.md', '# Aether v3 Pro\n\nStudio-grade minimalist editor.\n\n- **Save to OPFS** for persistent browser storage.\n- **Preview** for live HTML/Markdown.\n- **Ctrl+P** for Command Palette.', null, 'memory');

        Editor.init();
        FileSys.initOPFS();
    },

    openBuffer(name, content, handle, kind) {
        const existing = Store.state.buffers.find(b => b.name === name);
        if (existing) return Store.setActive(existing.id);
        Store.addBuffer({ id: 'b'+Date.now(), name, content, handle, kind, dirty: false });
    },

    closeBuffer(id, e) {
        e.stopPropagation();
        Store.closeBuffer(id);
    },

    updateStats() {
        const input = document.getElementById('input-layer');
        const text = input.value.substring(0, input.selectionStart);
        const lines = text.split('\n').length;
        const cols = text.split('\n').pop().length + 1;
        document.getElementById('stat-pos').innerText = `LN ${lines}, COL ${cols}`;
        const buf = Store.activeBuffer;
        if(buf) {
            document.getElementById('stat-file').innerText = buf.name.toUpperCase();
            document.getElementById('stat-lang').innerText = buf.name.split('.').pop().toUpperCase();
        }
        Editor.updateGutter(input.value);
    },

    debouncePreview(immediate) {
        if (!Store.state.previewMode) return;
        clearTimeout(this.pvTimer);
        const run = () => {
            const buf = Store.activeBuffer;
            if (!buf) return;
            const f = document.getElementById('preview-frame');
            const ext = buf.name.split('.').pop().toLowerCase();
            if (ext === 'md') f.srcdoc = `<style>body{font-family:system-ui,-apple-system,sans-serif;padding:2rem;line-height:1.6;color:#222;background:#fff;} pre{background:#f4f4f7;padding:1rem;border-radius:4px;overflow:auto;} code{font-family:monospace;background:#f4f4f7;padding:2px 4px;border-radius:3px;}</style>${marked.parse(buf.content)}`;
            else if (ext === 'html') f.srcdoc = buf.content;
            else f.srcdoc = '<div style="font-family:sans-serif;padding:2rem;color:#888;">No live preview available for this file type.</div>';
        };
        if(immediate) run(); else this.pvTimer = setTimeout(run, 500);
    },

    toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); },
    saveSession() { localStorage.setItem('aether_v3_session', JSON.stringify(Store.state.buffers.map(b => ({name:b.name, content:b.content})))); }
};

const UI = {
    renderTabs() {
        const con = document.getElementById('tabs-scroll');
        con.innerHTML = '';
        Store.state.buffers.forEach(b => {
            const el = document.createElement('div');
            el.className = `tab ${b.id === Store.state.activeId ? 'active' : ''} ${b.dirty ? 'dirty' : ''}`;
            el.innerHTML = `<span>${b.name}</span><span class="unsaved-dot"></span><span class="tab-close" onclick="App.closeBuffer('${b.id}', event)">âœ•</span>`;
            el.onclick = () => Store.setActive(b.id);
            con.appendChild(el);
        });
    },
    toast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 3000);
    }
};

const Commands = {
    list: [
        { id: 'newFile', name: 'New Memory File', hint: 'TMP', fn: () => Prompt.open("NEW FILENAME:", "script.js", (n) => App.openBuffer(n, "", null, 'memory')) },
        { id: 'newOPFS', name: 'Create OPFS File', hint: 'PERSISTENT', fn: () => FileSys.createOPFSFile() },
        { id: 'openFile', name: 'Open From Disk', hint: 'OS', fn: () => FileSys.openDiskFile() },
        { id: 'saveFile', name: 'Save to Disk', hint: 'DOWNLOAD', fn: () => Store.activeBuffer && FileSys.saveBuffer(Store.activeBuffer) },
        { id: 'saveToOPFS', name: 'Sync to OPFS', hint: 'SAVE', fn: () => Store.activeBuffer && FileSys.saveToOPFS(Store.activeBuffer) },
        { id: 'togglePreview', name: 'Toggle Live Preview', hint: 'UI', fn: () => {
            Store.state.previewMode = !Store.state.previewMode;
            document.body.classList.toggle('preview-active', Store.state.previewMode);
            App.debouncePreview(true);
        }},
        { id: 'toggleSide', name: 'Toggle Sidebar', hint: 'VIEW', fn: () => App.toggleSidebar() }
    ],
    trigger(id) { this.list.find(c => c.id === id).fn(); },
    showPalette() {
        const mask = document.getElementById('palette-mask');
        const list = document.getElementById('cmd-list');
        list.innerHTML = '';
        this.list.forEach(cmd => {
            const el = document.createElement('div');
            el.className = 'cmd-item';
            el.innerHTML = `<span>${cmd.name}</span><span class="cmd-hint">${cmd.hint}</span>`;
            el.onclick = () => { cmd.fn(); this.hidePalette(); };
            list.appendChild(el);
        });
        mask.style.display = 'flex';
        document.getElementById('cmd-input').value = '';
        document.getElementById('cmd-input').focus();
    },
    hidePalette() { document.getElementById('palette-mask').style.display = 'none'; }
};

const Prompt = {
    open(msg, def, cb) {
        document.getElementById('prompt-mask').style.display = 'flex';
        document.getElementById('prompt-msg').innerText = msg;
        const inp = document.getElementById('prompt-input');
        inp.value = def; inp.focus(); inp.select();
        document.getElementById('prompt-ok').onclick = () => { if(inp.value) cb(inp.value); this.close(); };
        inp.onkeydown = (e) => { if(e.key === 'Enter') document.getElementById('prompt-ok').click(); if(e.key === 'Escape') this.close(); };
    },
    close() { document.getElementById('prompt-mask').style.display = 'none'; }
};

const Resizer = {
    init() {
        const r = document.getElementById('resizer');
        const p = document.getElementById('preview-pane');
        r.onmousedown = () => {
            document.onmousemove = e => {
                const pct = (1 - (e.clientX / window.innerWidth)) * 100;
                p.style.width = Math.min(90, Math.max(10, pct)) + '%';
            };
            document.onmouseup = () => document.onmousemove = null;
        };
    }
};

window.onload = () => { 
    App.init(); 
    Resizer.init(); 
    window.onkeydown = (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') { e.preventDefault(); Commands.showPalette(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); Commands.trigger('saveFile'); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'b') { e.preventDefault(); Commands.trigger('toggleSide'); }
    };
};
</script>
</body>
</html>
