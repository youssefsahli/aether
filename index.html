    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#1e1e2e">
        <meta name="description" content="A powerful, modern code editor with live preview, themes, and OPFS storage">
        <title>Aether v3 - Ace Flux</title>

        <!-- PWA Manifest & Icon -->
        <link rel="manifest" href="/manifest.json">
        <link rel="icon" type="image/svg+xml" href="/favicon.svg">
        <link rel="apple-touch-icon" href="/favicon.svg">

        <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
        <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
        <script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>

        <!-- Ace Editor -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-pascal.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-html.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-css.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-markdown.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-tomorrow_night_eighties.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-chrome.min.js"></script>

        <!-- Markdown Parser -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

        <!-- Commands List -->
        <script src="filesys/commands.js"></script>

        <!-- Icon Library -->
        <script src="filesys/icons.js"></script>
        <link rel="stylesheet" href="filesys/styles.css">

        <!-- Modular JavaScript Modules -->
        <!-- Core Modules -->
        <script src="js/core/db.js"></script>
        <script src="js/core/utils.js"></script>
        
        <!-- State & Config -->
        <script src="js/modules/store.js"></script>
        <script src="js/modules/config.js"></script>
        
        <!-- Editor & Symbols -->
        <script src="js/modules/editor.js"></script>
        <script src="js/modules/symbols.js"></script>
        
        <!-- Scripting & File System -->
        <script src="js/modules/script.js"></script>
        <script src="js/modules/filesys.js"></script>
        <script src="js/modules/system-fs.js"></script>
        
        <!-- Markdown & Preview -->
        <script src="js/modules/marked-config.js"></script>
        
        <!-- UI Components -->
        <script src="js/modules/console.js"></script>
        <script src="js/ui/ui.js"></script>
        <script src="js/ui/dialogs.js"></script>
        <script src="js/ui/resizer.js"></script>
        <script src="js/ui/dragger.js"></script>
        
        <!-- App & Commands -->
        <script src="js/modules/app.js"></script>
        <script src="js/modules/commands.js"></script>
        
        <!-- Application Initialization -->
        <script src="js/init.js"></script>
    </head>

    <body data-theme="mocha">

        <header>
            <button class="btn" onclick="App.toggleSidebar('left')" title="Toggle Sidebar" data-icon="menu"></button>
            <div class="logo">
                <span style="font-size: 20px; font-weight: 700; color: var(--accent); font-family: var(--font-code);">Æ</span>
                <span>AETHER</span>
            </div>

            <div class="toolbar">
                <div class="theme-swatches">
                    <div class="theme-swatch swatch-latte" onclick="Config.setTheme('latte')" title="Latte"></div>
                    <div class="theme-swatch swatch-frappe" onclick="Config.setTheme('frappe')" title="Frappe"></div>
                    <div class="theme-swatch swatch-macchiato" onclick="Config.setTheme('macchiato')" title="Macchiato">
                    </div>
                    <div class="theme-swatch swatch-mocha" onclick="Config.setTheme('mocha')" title="Mocha"></div>
                </div>
                <div style="width:1px; height:16px; background:var(--border); margin:0 8px;"></div>
                <button class="btn" onclick="Commands.trigger('openFile')" title="Open File (Ctrl+O)" data-icon="openFile"></button>
                <button class="btn" onclick="Commands.trigger('newFile')" title="New File (Alt+N)" data-icon="newFile"></button>
                <button class="btn" onclick="Commands.trigger('saveFile')" title="Save (Ctrl+S)" data-icon="save"></button>
                <div style="width:1px; height:16px; background:var(--border); margin:0 8px;"></div>
                <button id="nav-back-btn" class="btn" onclick="App.goBack()" title="Back (Alt+Left)" disabled data-icon="back"></button>
                <button id="nav-forward-btn" class="btn" onclick="App.goForward()" title="Forward (Alt+Right)" disabled data-icon="forward"></button>
                <div style="width:1px; height:16px; background:var(--border); margin:0 8px;"></div>
                <button class="btn primary" onclick="Commands.trigger('togglePreview')" title="Preview" data-icon="preview"></button>
                <button class="btn" onclick="App.toggleSidebar('right')" title="Outline" data-icon="outline"></button>
                <button class="btn" onclick="Commands.showPalette()" title="Commands (F1)" data-icon="commands"></button>
            </div>
        </header>

        <div id="app-shell">
            <aside id="sidebar-left">
                <div class="side-header" style="margin-top:8px;">
                    <span>Workspace</span>
                    <div style="display:flex; gap:4px;">
                        <button class="btn" onclick="TreeSearch.collapseAll('file-tree')" title="Collapse All"></button>
                        <button class="btn" onclick="FileSys.createWorkspaceDir()" title="New Directory"></button>
                        <button class="btn" onclick="FileSys.openFolder()" title="Open Folder"></button>
                    </div>
                </div>
                <div class="tree-search-container">
                    <input type="text" id="file-tree-search" class="tree-search" placeholder="Search files..." onkeyup="TreeSearch.filterTree('file-tree', this.value)">
                </div>
                <div id="file-tree" class="file-tree"></div>

                <div class="side-header" style="border-top:1px solid var(--border); padding-top:8px; margin-top:8px;">
                    <span id="opfs-header">Local Storage</span>
                    <div style="display:flex; gap:4px;">
                        <button class="btn" onclick="TreeSearch.collapseAll('opfs-tree')" title="Collapse All"></button>
                        <button class="btn" onclick="FileSys.createOPFSDir()" title="New Directory"></button>
                        <button class="btn" onclick="FileSys.createOPFSFile()" title="New Local File"></button>
                    </div>
                </div>
                <div class="tree-search-container">
                    <input type="text" id="opfs-tree-search" class="tree-search" placeholder="Search files..." onkeyup="TreeSearch.filterTree('opfs-tree', this.value)">
                </div>
                <div id="opfs-tree" class="file-tree" style="max-height: 250px;"></div>

                <div class="side-header" style="border-top:1px solid var(--border); padding-top:8px; margin-top:8px;">
                    <span>System Files</span>
                </div>
                <div class="tree-search-container">
                    <input type="text" id="system-tree-search" class="tree-search" placeholder="Search files..." onkeyup="TreeSearch.filterTree('system-tree', this.value)">
                </div>
                <div id="system-tree" class="file-tree" style="max-height: 250px;"></div>
            </aside>

            <main>
                <div id="tabs-scroll"></div>
                <div class="breadcrumbs">
                    <span>root</span><span>/</span><span id="bc-filename" style="color:var(--text)">[No Selection]</span>
                </div>

                <div id="editor-row">
                    <div id="editor-split">
                        <div id="code-stage"></div>
                        <div id="resizer"></div>

                        <div id="preview-pane">
                            <div class="preview-header" id="preview-header">
                                <span style="font-size:10px; font-weight:700; color:var(--text-dim);">PREVIEW</span>
                                <button class="btn" style="width:20px; height:20px;"
                                    onclick="Commands.trigger('togglePreview')">
                                    ✕
                                </button>
                            </div>
                            <iframe id="preview-frame"
                                sandbox="allow-scripts allow-modals allow-forms allow-same-origin"></iframe>
                            <div id="console-pane"
                                style="height: 150px; border-top: 1px solid var(--border); background: var(--header-bg); display: flex; flex-direction: column;">
                                <div class="console-header" style="display:flex; align-items:center; justify-content:space-between; padding:6px 8px; border-bottom:1px solid var(--border);">
                                    <span style="font-size:11px; font-weight:700; color:var(--text-dim);">CONSOLE</span>
                                    <div style="display:flex; gap:6px;">
                                        <button id="console-toggle-btn" class="btn" style="width:auto; padding:6px 8px; font-size:12px;" title="Collapse Console" onclick="UI.toggleConsole()">
                                            ▼
                                        </button>
                                        <button id="console-run-btn" class="btn" style="width:auto; padding:6px 8px; font-size:12px;" title="Run JS" onclick="App.runActiveJSInConsole()" hidden>
                                            ▶
                                        </button>
                                        <button id="console-clear-btn" class="btn" style="width:auto; padding:6px 8px; font-size:12px;" title="Clear Console" onclick="UI.clearConsole()">
                                            ✕
                                        </button>
                                    </div>
                                </div>
                                <div id="console-logs"
                                    style="flex:1; overflow-y: auto; padding: 8px; font-family: var(--font-code); font-size: 11px; color:var(--text);">
                                </div>
                                <div id="console-input-wrapper" style="display: flex; align-items: center; padding: 6px 8px; border-top: 1px solid var(--border); background: var(--header-bg); position: relative; gap: 6px;">
                                    <span id="console-prompt" style="color: var(--accent); font-weight: 600; font-size: 11px; flex-shrink: 0;">»</span>
                                    <div style="flex: 1; position: relative;">
                                        <input id="console-input" type="text" autocomplete="off" placeholder="Enter JavaScript..." style="width: 100%; background: var(--input-bg, rgba(255,255,255,0.05)); border: 1px solid var(--border); color: var(--text); padding: 4px 6px; border-radius: 3px; font-family: var(--font-code); font-size: 11px; box-sizing: border-box;" />
                                        <div id="console-autocomplete" style="position: absolute; bottom: 100%; left: 0; right: 0; background: var(--bg); border: 1px solid var(--border); border-bottom: none; border-radius: 3px 3px 0 0; max-height: 150px; overflow-y: auto; display: none; z-index: 1000; font-family: var(--font-code); font-size: 11px; margin-bottom: 2px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="float-resizer"></div>
                        </div>
                    </div>

                    <aside id="sidebar-right" class="collapsed">
                        <div class="side-header" style="margin-top:8px;"><span>Outline</span></div>
                        <div class="outline-search">
                            <input id="outline-filter" placeholder="Filter symbols..." aria-label="Outline filter">
                        </div>
                        <div id="symbol-tree" class="file-tree"></div>
                    </aside>
                </div>
            </main>
        </div>

        <footer>
            <div class="stat-group">
                <span class="stat-highlight">ACE FLUX</span>
                <span style="opacity:0.3">|</span>
                <span class="stat-box" id="stat-file">--</span>
            </div>
            <div class="stat-group">
                <span class="stat-box" id="stat-lang">TXT</span>
                <span class="stat-box" id="stat-pos">1:1</span>
                <span class="stat-box" id="stat-indent">Space: 4</span>
            </div>
        </footer>

        <div id="palette-mask" class="overlay-mask" onclick="if(event.target===this) Commands.hidePalette()">
            <div class="dialog">
                <input type="text" id="cmd-input" placeholder="> Type a command..." autocomplete="off">
                <div id="cmd-list" style="max-height: 350px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="prompt-mask" class="overlay-mask">
            <div class="dialog">
                <div style="padding:14px 20px; font-weight:700; background:var(--header-bg); color:var(--text); border-bottom:1px solid var(--border); font-size:12px; text-transform:uppercase;"
                    id="prompt-msg">Input</div>
                <input type="text" id="prompt-input" autocomplete="off" style="background:var(--bg)">
                <div style="display:flex; padding:12px; gap:8px; background: var(--header-bg); justify-content: flex-end;">
                    <button class="btn" style="width:auto; padding:6px 12px; font-size:12px;"
                        onclick="Prompt.close()">Cancel</button>
                    <button class="btn primary" style="width:auto; padding:6px 12px; font-size:12px;"
                        id="prompt-ok">Submit</button>
                </div>
            </div>
        </div>

        <div id="confirm-mask" class="overlay-mask">
            <div class="dialog">
                <div style="padding:14px 20px; font-weight:700; background:var(--header-bg); color:var(--text); border-bottom:1px solid var(--border); font-size:12px; text-transform:uppercase;"
                    id="confirm-title">Confirmation</div>
                <div style="padding:20px 20px; color:var(--text); font-size:13px;" id="confirm-msg">Are you sure?</div>
                <div style="display:flex; padding:12px; gap:8px; background: var(--header-bg); justify-content: flex-end;">
                    <button class="btn" style="width:auto; padding:6px 12px; font-size:12px;"
                        onclick="Confirm.close()">Cancel</button>
                    <button class="btn primary" style="width:auto; padding:6px 12px; font-size:12px; color:#ff8888;"
                        id="confirm-ok">Confirm</button>
                </div>
            </div>
        </div>

        <!-- New File Dialog with Templates -->
        <div id="newfile-mask" class="overlay-mask">
            <div class="dialog" style="width: 360px;">
                <div style="padding:14px 20px; font-weight:700; background:var(--header-bg); color:var(--text); border-bottom:1px solid var(--border); font-size:12px; text-transform:uppercase;">
                    New File
                </div>
                <div style="padding: 16px;">
                    <input type="text" id="newfile-input" placeholder="filename.js" autocomplete="off" 
                        style="background:var(--bg); width:100%; margin-bottom:12px;">
                    <div style="font-size:11px; color:var(--text-muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">
                        Templates
                    </div>
                    <div id="newfile-templates" class="template-list">
                        <div class="template-hint">Type a filename to see templates</div>
                    </div>
                </div>
                <div style="display:flex; padding:12px; gap:8px; background: var(--header-bg); justify-content: flex-end;">
                    <button class="btn" style="width:auto; padding:6px 12px; font-size:12px;"
                        onclick="NewFilePrompt.close()">Cancel</button>
                    <button class="btn primary" style="width:auto; padding:6px 12px; font-size:12px;"
                        id="newfile-ok">Create</button>
                </div>
            </div>
        </div>

        <div id="toast">
            ✓
            <span id="toast-msg">Initialized</span>
        </div>

        <!-- Application code moved to js/modules -->

    </body>

    </html>
