    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#1e1e2e">
        <title>Aether v3 - Ace Flux</title>

        <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
        <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
        <script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>

        <!-- Ace Editor -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-html.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-css.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-markdown.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-tomorrow_night_eighties.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-chrome.min.js"></script>

        <!-- Markdown Parser -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

        <style>
            :root {
                /* Catppuccin Mocha Defaults */
                --bg: #1e1e2e;
                --sidebar-bg: #181825;
                --header-bg: #11111b;
                --tab-bg: #11111b;
                --tab-active-bg: #1e1e2e;

                --text: #cdd6f4;
                --text-dim: #9399b2;
                --text-dark: #6c7086;

                --accent: #89b4fa;
                --accent-sec: #b4befe;
                --border: #313244;
                --highlight: #313244;

                --cursor: #f5e0dc;
                --status-bg: #89b4fa;
                --status-fg: #1e1e2e;

                --font-code: 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
                --font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;

                --header-h: 36px;
                --footer-h: 28px;
                --sidebar-w: 240px;
                --outline-w: 200px;
                /* Width of symbol bar */
                --tab-h: 32px;
            }

            [data-theme="macchiato"] {
                --bg: #24273a;
                --sidebar-bg: #1e2030;
                --header-bg: #181926;
                --tab-bg: #181926;
                --tab-active-bg: #24273a;
                --text: #cad3f5;
                --text-dim: #939ab7;
                --text-dark: #6e738d;
                --accent: #8aadf4;
                --accent-sec: #b7bdf8;
                --border: #363a4f;
                --highlight: #363a4f;
                --cursor: #f4dbd6;
                --status-bg: #8aadf4;
                --status-fg: #24273a;
            }

            [data-theme="frappe"] {
                --bg: #303446;
                --sidebar-bg: #292c3c;
                --header-bg: #232634;
                --tab-bg: #232634;
                --tab-active-bg: #303446;
                --text: #c6d0f5;
                --text-dim: #949cbb;
                --text-dark: #737994;
                --accent: #8caaee;
                --accent-sec: #babbf1;
                --border: #414559;
                --highlight: #414559;
                --cursor: #f2d5cf;
                --status-bg: #8caaee;
                --status-fg: #303446;
            }

            [data-theme="latte"] {
                --bg: #eff1f5;
                --sidebar-bg: #e6e9ef;
                --header-bg: #dce0e8;
                --tab-bg: #dce0e8;
                --tab-active-bg: #eff1f5;
                --text: #4c4f69;
                --text-dim: #9ca0b0;
                --text-dark: #acb0be;
                --accent: #1e66f5;
                --accent-sec: #7287fd;
                --border: #bcc0cc;
                --highlight: #ccd0da;
                --cursor: #dc8a78;
                --status-bg: #1e66f5;
                --status-fg: #eff1f5;
            }

            *:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: -1px;
            }

            * {
                box-sizing: border-box;
                /* outline: none; */
                -webkit-tap-highlight-color: transparent;
            }

            body {
                margin: 0;
                background: var(--bg);
                color: var(--text);
                height: 100dvh;
                width: 100vw;
                overflow: hidden;
                font-family: var(--font-ui);
                display: flex;
                flex-direction: column;
                font-size: 13px;
                letter-spacing: -0.01em;
                transition: background 0.2s, color 0.2s;
            }

            * {
                scrollbar-width: thin;
                scrollbar-color: var(--highlight) transparent;
            }

            /* Dragging state */
            body.resizing {
                cursor: col-resize !important;
                user-select: none;
            }

            body.resizing iframe {
                pointer-events: none;
            }

            body.dragging-preview {
                cursor: move !important;
                user-select: none;
            }

            body.dragging-preview iframe {
                pointer-events: none;
            }

            body.drag-over::after {
                content: 'DROP FILE TO OPEN';
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--accent);
                font-weight: 800;
                font-size: 24px;
                z-index: 999;
                backdrop-filter: blur(4px);
                pointer-events: none;
            }

            svg.icon {
                width: 15px;
                height: 15px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2;
                stroke-linecap: round;
                stroke-linejoin: round;
            }

            /* --- Layout --- */
            #app-shell {
                display: flex;
                flex: 1;
                overflow: hidden;
            }

            aside {
                background: var(--sidebar-bg);
                border-right: 1px solid var(--border);
                display: flex;
                flex-direction: column;
                z-index: 10;
                flex-shrink: 0;
                transition: margin-left 0.2s cubic-bezier(0.4, 0, 0.2, 1), margin-right 0.2s;
            }

            #sidebar-left {
                width: var(--sidebar-w);
            }

            #sidebar-left.collapsed {
                margin-left: calc(var(--sidebar-w) * -1);
            }

            #sidebar-right {
                width: var(--outline-w);
                border-right: none;
                border-left: 1px solid var(--border);
                transition: margin-right 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }

            #sidebar-right.collapsed {
                margin-right: calc(var(--outline-w) * -1);
            }

            .side-header {
                padding: 0 16px;
                font-weight: 700;
                font-size: 11px;
                color: var(--text-dim);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                height: 36px;
            }

            .file-tree {
                flex: 1;
                overflow-y: auto;
                padding: 8px 0;
            }

            .tree-item {
                padding: 4px 16px;
                font-size: 13px;
                color: var(--text-dim);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: space-between;
                white-space: nowrap;
                overflow: hidden;
                height: 26px;
                margin: 0 8px;
                border-radius: 4px;
            }

            .tree-item-label {
                display: flex;
                align-items: center;
                gap: 8px;
                overflow: hidden;
                text-overflow: ellipsis;
                font-family: var(--font-ui);
            }

            .tree-item:hover {
                background: var(--highlight);
                color: var(--text);
            }

            .tree-item.active {
                background: var(--highlight);
                color: var(--accent);
                font-weight: 500;
            }

            /* Symbol List Styling */
            .symbol-item {
                padding: 4px 12px;
                font-size: 12px;
                color: var(--text-dim);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                border-left: 2px solid transparent;
            }

            .symbol-item:hover {
                color: var(--text);
                background: var(--highlight);
            }

            .symbol-kind {
                opacity: 0.5;
                font-size: 10px;
                width: 14px;
                text-align: center;
            }

            .symbol-name {
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .tree-actions {
                display: flex;
                gap: 4px;
                opacity: 0;
            }

            .tree-item:hover .tree-actions {
                opacity: 1;
            }

            .action-btn {
                padding: 3px;
                border-radius: 4px;
                cursor: pointer;
                display: flex;
                align-items: center;
                opacity: 0.7;
            }

            .action-btn:hover {
                background: rgba(255, 255, 255, 0.1);
                color: var(--text);
                opacity: 1;
            }

            .action-delete:hover {
                background: rgba(255, 100, 100, 0.15);
                color: #ff8888;
            }

            .reconnect-btn {
                margin: 10px 16px;
                padding: 8px;
                background: rgba(137, 180, 250, 0.1);
                border: 1px dashed var(--accent);
                color: var(--accent);
                text-align: center;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                font-weight: 500;
            }

            .reconnect-btn:hover {
                background: var(--accent);
                color: var(--bg);
            }

            main {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-width: 0;
                position: relative;
                background: var(--bg);
            }

            /* Tabs */
            #tabs-scroll {
                height: var(--tab-h);
                background: var(--header-bg);
                display: flex;
                overflow-x: auto;
                scrollbar-width: none;
                gap: 1px;
                padding: 0;
            }

            #tabs-scroll::-webkit-scrollbar {
                display: none;
            }

            .tab {
                height: 100%;
                padding: 0 12px;
                display: flex;
                align-items: center;
                color: var(--text-dim);
                font-size: 12px;
                cursor: pointer;
                min-width: 100px;
                max-width: 200px;
                position: relative;
                background: transparent;
                justify-content: space-between;
                border-right: 1px solid var(--border);
                transition: all 0.1s;
                font-family: var(--font-ui);
                border-top: 2px solid transparent;
            }

            .tab:hover {
                background: var(--highlight);
                color: var(--text);
            }

            .tab.active {
                background: var(--bg);
                color: var(--accent);
                border-top: 2px solid var(--accent);
                font-weight: 500;
            }

            .tab-close {
                opacity: 0;
                padding: 2px;
                font-size: 14px;
                margin-left: 8px;
                line-height: 1;
                border-radius: 3px;
                width: 16px;
                height: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .tab:hover .tab-close,
            .tab.active .tab-close {
                opacity: 0.6;
            }

            .tab-close:hover {
                background: rgba(255, 100, 100, 0.15);
                color: #ff8888;
                opacity: 1 !important;
            }

            .unsaved-dot {
                width: 8px;
                height: 8px;
                background: var(--text-dim);
                border-radius: 50%;
                display: none;
                margin-left: auto;
                transform: scale(0.8);
            }

            .tab.dirty .unsaved-dot {
                display: block;
            }

            .tab.dirty:hover .unsaved-dot {
                display: none;
            }

            .tab.dirty:hover .tab-close {
                display: flex;
            }

            .tab.active .unsaved-dot {
                background: var(--accent);
            }

            .breadcrumbs {
                height: 28px;
                background: var(--bg);
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                padding: 0 16px;
                gap: 8px;
                font-size: 11px;
                color: var(--text-dark);
            }

            #editor-row {
                flex: 1;
                display: flex;
                overflow: hidden;
                position: relative;
            }

            #editor-split {
                flex: 1;
                display: flex;
                position: relative;
                min-width: 0;
            }

            #code-stage {
                flex: 1;
                position: relative;
            }

            /* Preview Pane Styles */
            #preview-pane {
                background: var(--bg);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                border-left: 1px solid var(--border);
                /* Defaults for split mode handled by JS/CSS classes */
            }

            /* Split Mode (Default) */
            #editor-split:not(.mode-float) #preview-pane {
                width: 0;
                transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            }

            .preview-active #editor-split:not(.mode-float) #preview-pane {
                width: 50%;
            }

            /* Float Mode */
            #editor-split.mode-float #preview-pane {
                position: absolute;
                width: 400px;
                height: 300px;
                top: 20px;
                right: 20px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                border: 1px solid var(--border);
                border-radius: 8px;
                z-index: 100;
                display: none;
            }

            .preview-active #editor-split.mode-float #preview-pane {
                display: flex;
            }

            .preview-header {
                height: 28px;
                background: var(--header-bg);
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 8px;
                cursor: default;
            }

            /* Only draggable header in float mode */
            #editor-split.mode-float .preview-header {
                cursor: move;
            }

            iframe {
                width: 100%;
                height: 100%;
                border: none;
                background: #fff;
                flex: 1;
            }

            /* Resize Handles */
            #resizer {
                width: 4px;
                background: transparent;
                cursor: col-resize;
                position: absolute;
                top: 0;
                bottom: 0;
                z-index: 50;
                display: none;
                transition: background 0.2s;
            }

            #resizer:hover,
            #resizer.active {
                background: var(--accent);
            }

            .preview-active #editor-split:not(.mode-float) #resizer {
                display: block;
            }

            #float-resizer {
                width: 14px;
                height: 14px;
                position: absolute;
                bottom: 0;
                right: 0;
                cursor: se-resize;
                z-index: 101;
                display: none;
                background: linear-gradient(135deg, transparent 50%, var(--accent) 50%);
                opacity: 0.6;
                border-bottom-right-radius: 7px;
            }

            #editor-split.mode-float #float-resizer {
                display: block;
            }

            #float-resizer:hover {
                opacity: 1;
            }

            header {
                height: var(--header-h);
                background: var(--header-bg);
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                padding: 0 12px;
                gap: 12px;
            }

            .logo {
                font-weight: 800;
                color: var(--accent);
                font-size: 14px;
                margin-right: 12px;
                letter-spacing: -0.5px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .toolbar {
                display: flex;
                align-items: center;
                gap: 6px;
                margin-left: auto;
            }

            .theme-swatches {
                display: flex;
                gap: 6px;
                margin-right: 12px;
            }

            .theme-swatch {
                width: 12px;
                height: 12px;
                cursor: pointer;
                border: 1px solid var(--border);
                border-radius: 50%;
            }

            .theme-swatch:hover {
                transform: scale(1.1);
                border-color: var(--text);
            }

            .swatch-latte {
                background: #eff1f5;
            }

            .swatch-frappe {
                background: #303446;
            }

            .swatch-macchiato {
                background: #24273a;
            }

            .swatch-mocha {
                background: #1e1e2e;
            }

            /* New Footer Style */
            footer {
                height: var(--footer-h);
                background: var(--header-bg);
                border-top: 2px solid var(--accent);
                color: var(--text-dim);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 12px;
                font-size: 11px;
                font-weight: 500;
                user-select: none;
                z-index: 50;
                position: relative;
            }

            .stat-group {
                display: flex;
                height: 100%;
                gap: 16px;
                align-items: center;
            }

            .stat-box {
                display: flex;
                align-items: center;
                gap: 6px;
                opacity: 0.8;
            }

            .stat-box:hover {
                opacity: 1;
                color: var(--text);
            }

            .stat-highlight {
                color: var(--accent);
                font-weight: 700;
            }

            .btn {
                background: transparent;
                border: 1px solid transparent;
                color: var(--text-dim);
                padding: 4px;
                width: 28px;
                height: 28px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 5px;
                transition: all 0.1s;
            }

            .btn:hover {
                background: var(--highlight);
                color: var(--text);
            }

            .btn.primary {
                color: var(--accent);
                background: rgba(137, 180, 250, 0.1);
            }

            .btn.primary:hover {
                background: var(--accent);
                color: var(--bg);
            }

            .overlay-mask {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                z-index: 100;
                display: none;
                align-items: flex-start;
                justify-content: center;
                padding-top: 80px;
                backdrop-filter: blur(4px);
            }

            .dialog {
                background: var(--bg);
                border: 1px solid var(--border);
                width: 480px;
                box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5);
                display: flex;
                flex-direction: column;
                border-radius: 8px;
                overflow: hidden;
            }

            .dialog input {
                background: var(--header-bg);
                border: none;
                color: var(--text);
                padding: 14px 20px;
                font-size: 14px;
                width: 100%;
                border-bottom: 1px solid var(--border);
                font-family: var(--font-code);
            }

            .cmd-item {
                padding: 10px 20px;
                cursor: pointer;
                font-size: 13px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                color: var(--text-dim);
            }

            .cmd-item:hover,
            .cmd-item.selected {
                background: var(--highlight);
                color: var(--accent);
            }

            .cmd-shortcut {
                font-size: 11px;
                opacity: 0.6;
                font-family: var(--font-ui);
                background: var(--border);
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: 500;
            }

            #toast {
                position: fixed;
                bottom: 36px;
                right: 20px;
                background: var(--sidebar-bg);
                color: var(--text);
                border: 1px solid var(--border);
                border-left: 4px solid var(--accent);
                padding: 8px 16px;
                font-size: 12px;
                font-weight: 500;
                border-radius: 4px;
                display: flex;
                align-items: center;
                gap: 10px;
                transform: translateY(10px);
                opacity: 0;
                pointer-events: none;
                transition: all 0.2s;
                z-index: 200;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            }

            #toast.visible {
                transform: translateY(0);
                opacity: 1;
                pointer-events: auto;
            }

            #toast svg {
                color: var(--accent);
            }

            /* Custom Scrollbar */
            ::-webkit-scrollbar {
                width: 10px;
                height: 10px;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 5px;
                border: 2px solid var(--bg);
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            /* Ace Tweaks */
            .ace_editor {
                font-family: var(--font-code) !important;
                line-height: 1.6 !important;
            }

            .ace_gutter {
                background: var(--bg) !important;
                color: var(--text-dark) !important;
                border-right: 1px solid var(--border);
            }

            .ace_content {
                background: var(--bg) !important;
            }

            .ace_active-line {
                background: rgba(255, 255, 255, 0.03) !important;
            }

            .ace_gutter-active-line {
                background: rgba(255, 255, 255, 0.03) !important;
            }
        </style>
    </head>

    <body data-theme="mocha">

        <header>
            <button class="btn" onclick="App.toggleSidebar('left')" title="Toggle Sidebar">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M3 12h18M3 6h18M3 18h18" />
                </svg>
            </button>
            <div class="logo">
                <svg class="icon" viewBox="0 0 24 24" style="color:var(--accent); width:18px; height:18px;">
                    <polygon points="12 2 2 7 12 12 22 7 12 2" />
                    <polyline points="2 17 12 22 22 17" />
                    <polyline points="2 12 12 17 22 12" />
                </svg>
                <span>AETHER</span>
            </div>

            <div class="toolbar">
                <div class="theme-swatches">
                    <div class="theme-swatch swatch-latte" onclick="Config.setTheme('latte')" title="Latte"></div>
                    <div class="theme-swatch swatch-frappe" onclick="Config.setTheme('frappe')" title="Frappe"></div>
                    <div class="theme-swatch swatch-macchiato" onclick="Config.setTheme('macchiato')" title="Macchiato">
                    </div>
                    <div class="theme-swatch swatch-mocha" onclick="Config.setTheme('mocha')" title="Mocha"></div>
                </div>
                <div style="width:1px; height:16px; background:var(--border); margin:0 8px;"></div>
                <button class="btn" onclick="Commands.trigger('openFile')" title="Open File (Ctrl+O)">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M3 7a2 2 0 0 1 2-2h4l2 3h8a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"></path></svg>
                </button>
                <button class="btn" onclick="Commands.trigger('newFile')" title="New File (Alt+N)">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12 5v14M5 12h14" />
                    </svg>
                </button>
                <button class="btn" onclick="Commands.trigger('saveFile')" title="Save (Ctrl+S)">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                    </svg>
                </button>
                <div style="width:1px; height:16px; background:var(--border); margin:0 8px;"></div>
                <button class="btn primary" onclick="Commands.trigger('togglePreview')" title="Preview">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M5 12s2.545-5 7-5c4.454 0 7 5 7 5s-2.546 5-7 5c-4.455 0-7-5-7-5z" />
                        <path d="M12 13a1 1 0 100-2 1 1 0 000 2z" />
                    </svg>
                </button>
                <button class="btn" onclick="App.toggleSidebar('right')" title="Outline">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="21" y1="10" x2="3" y2="10"></line>
                        <line x1="21" y1="6" x2="3" y2="6"></line>
                        <line x1="21" y1="14" x2="3" y2="14"></line>
                        <line x1="21" y1="18" x2="3" y2="18"></line>
                    </svg>
                </button>
                <button class="btn" onclick="Commands.showPalette()" title="Commands (F1)">
                    <svg class="icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="1" />
                        <circle cx="19" cy="12" r="1" />
                        <circle cx="5" cy="12" r="1" />
                    </svg>
                </button>
            </div>
        </header>

        <div id="app-shell">
            <aside id="sidebar-left">
                <div class="side-header" style="margin-top:8px;">
                    <span>Workspace</span>
                    <button class="btn" onclick="FileSys.openFolder()" title="Open Folder">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                        </svg>
                    </button>
                </div>
                <div id="file-tree" class="file-tree"></div>

                <div class="side-header" style="border-top:1px solid var(--border); padding-top:8px; margin-top:8px;">
                    <span id="opfs-header">Local Storage</span>
                    <div style="display:flex;">
                        <button class="btn" onclick="FileSys.createOPFSFile()" title="New Local File">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M12 5v14M5 12h14" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="opfs-tree" class="file-tree" style="max-height: 250px;"></div>
            </aside>

            <main>
                <div id="tabs-scroll"></div>
                <div class="breadcrumbs">
                    <span>root</span><span>/</span><span id="bc-filename" style="color:var(--text)">[No Selection]</span>
                </div>

                <div id="editor-row">
                    <div id="editor-split">
                        <div id="code-stage"></div>
                        <div id="resizer"></div>

                        <div id="preview-pane">
                            <div class="preview-header" id="preview-header">
                                <span style="font-size:10px; font-weight:700; color:var(--text-dim);">PREVIEW</span>
                                <button class="btn" style="width:20px; height:20px;"
                                    onclick="Commands.trigger('togglePreview')">
                                    <svg class="icon" style="width:12px; height:12px;" viewBox="0 0 24 24">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                            <iframe id="preview-frame"
                                sandbox="allow-scripts allow-modals allow-forms allow-same-origin"></iframe>
                            <div id="console-pane"
                                style="height: 150px; border-top: 1px solid var(--border); background: var(--header-bg); display: flex; flex-direction: column;">
                                <div style="display:flex; align-items:center; justify-content:space-between; padding:6px 8px; border-bottom:1px solid var(--border);">
                                    <span style="font-size:11px; font-weight:700; color:var(--text-dim);">CONSOLE</span>
                                    <div style="display:flex; gap:6px;">
                                        <button id="console-run-btn" class="btn" style="width:auto; padding:6px 8px; font-size:12px;" title="Run JS" onclick="App.runActiveJS()" hidden>
                                            <svg class="icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21"></polygon></svg>
                                        </button>
                                        <button id="console-clear-btn" class="btn" style="width:auto; padding:6px 8px; font-size:12px;" title="Clear Console" onclick="UI.clearConsole()">
                                            <svg class="icon" viewBox="0 0 24 24"><path d="M3 21l8-8"></path><path d="M21 3l-6 6"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div id="console-logs"
                                    style="flex:1; overflow-y: auto; padding: 8px; font-family: var(--font-code); font-size: 11px;">
                                </div>
                            </div>
                            <div id="float-resizer"></div>
                        </div>
                    </div>

                    <aside id="sidebar-right" class="collapsed">
                        <div class="side-header" style="margin-top:8px;"><span>Outline</span></div>
                        <div id="symbol-tree" class="file-tree"></div>
                    </aside>
                </div>
            </main>
        </div>

        <footer>
            <div class="stat-group">
                <span class="stat-highlight">ACE FLUX</span>
                <span style="opacity:0.3">|</span>
                <span class="stat-box" id="stat-file">--</span>
            </div>
            <div class="stat-group">
                <span class="stat-box" id="stat-lang">TXT</span>
                <span class="stat-box" id="stat-pos">1:1</span>
                <span class="stat-box" id="stat-indent">Space: 4</span>
            </div>
        </footer>

        <div id="palette-mask" class="overlay-mask" onclick="if(event.target===this) Commands.hidePalette()">
            <div class="dialog">
                <input type="text" id="cmd-input" placeholder="> Type a command..." autocomplete="off">
                <div id="cmd-list" style="max-height: 350px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="prompt-mask" class="overlay-mask">
            <div class="dialog">
                <div style="padding:14px 20px; font-weight:700; background:var(--header-bg); color:var(--text); border-bottom:1px solid var(--border); font-size:12px; text-transform:uppercase;"
                    id="prompt-msg">Input</div>
                <input type="text" id="prompt-input" autocomplete="off" style="background:var(--bg)">
                <div style="display:flex; padding:12px; gap:8px; background: var(--header-bg); justify-content: flex-end;">
                    <button class="btn" style="width:auto; padding:6px 12px; font-size:12px;"
                        onclick="Prompt.close()">Cancel</button>
                    <button class="btn primary" style="width:auto; padding:6px 12px; font-size:12px;"
                        id="prompt-ok">Submit</button>
                </div>
            </div>
        </div>

        <div id="confirm-mask" class="overlay-mask">
            <div class="dialog">
                <div style="padding:14px 20px; font-weight:700; background:var(--header-bg); color:var(--text); border-bottom:1px solid var(--border); font-size:12px; text-transform:uppercase;"
                    id="confirm-title">Confirmation</div>
                <div style="padding:20px 20px; color:var(--text); font-size:13px;" id="confirm-msg">Are you sure?</div>
                <div style="display:flex; padding:12px; gap:8px; background: var(--header-bg); justify-content: flex-end;">
                    <button class="btn" style="width:auto; padding:6px 12px; font-size:12px;"
                        onclick="Confirm.close()">Cancel</button>
                    <button class="btn primary" style="width:auto; padding:6px 12px; font-size:12px; color:#ff8888;"
                        id="confirm-ok">Confirm</button>
                </div>
            </div>
        </div>

        <div id="toast">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span id="toast-msg">Initialized</span>
        </div>

        <script>
            /**
            * AETHER v3 - Final Polish + Persistence + Floating Preview + Symbols + Resizing
            */

            const DB = {
                db: null,
                async init() {
                    return new Promise((resolve, reject) => {
                        const req = indexedDB.open('AetherDB', 2);
                        req.onupgradeneeded = (e) => {
                            const db = e.target.result;
                            if (!db.objectStoreNames.contains('handles')) db.createObjectStore('handles');
                            if (!db.objectStoreNames.contains('session')) db.createObjectStore('session', { keyPath: 'id' });
                        };
                        req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                        req.onerror = reject;
                    });
                },
                async set(store, key, val) {
                    if (!this.db) return;
                    return new Promise((resolve) => {
                        const tx = this.db.transaction(store, 'readwrite');
                        if (store === 'session') tx.objectStore(store).put(val);
                        else tx.objectStore(store).put(val, key);
                        tx.oncomplete = resolve;
                    });
                },
                async get(store, key) {
                    if (!this.db) return null;
                    return new Promise((resolve) => {
                        const tx = this.db.transaction(store, 'readonly');
                        const req = tx.objectStore(store).get(key);
                        req.onsuccess = () => resolve(req.result);
                    });
                },
                async getAll(store) {
                    if (!this.db) return [];
                    return new Promise((resolve) => {
                        const tx = this.db.transaction(store, 'readonly');
                        const req = tx.objectStore(store).getAll();
                        req.onsuccess = () => resolve(req.result);
                    });
                },
                async clear(store) {
                    if (!this.db) return;
                    return new Promise(r => {
                        const tx = this.db.transaction(store, 'readwrite');
                        tx.objectStore(store).clear();
                        tx.oncomplete = r;
                    });
                }
            };

            const Config = {
                defaults: { theme: 'mocha', fontSize: 13, sidebarWidth: 220, wordWrap: true, previewType: 'split' },
                state: {},
                init() {
                    try { this.state = { ...this.defaults, ...JSON.parse(localStorage.getItem('aether_config') || '{}') }; }
                    catch (e) { this.state = { ...this.defaults }; }
                    this.apply();
                },
                save() { localStorage.setItem('aether_config', JSON.stringify(this.state)); this.apply(); },
                setTheme(name) { this.state.theme = name; this.save(); },
                toggleWrap() { this.state.wordWrap = !this.state.wordWrap; this.save(); UI.toast(`Word Wrap: ${this.state.wordWrap ? 'ON' : 'OFF'}`); },
                togglePreviewType() {
                    this.state.previewType = this.state.previewType === 'split' ? 'float' : 'split';
                    this.save();
                    UI.toast(`Preview: ${this.state.previewType.toUpperCase()}`);
                },
                zoom(delta) { this.state.fontSize = Math.max(10, Math.min(24, this.state.fontSize + delta)); this.save(); UI.toast(`Zoom: ${this.state.fontSize}px`); },
                apply() {
                    document.body.setAttribute('data-theme', this.state.theme);
                    document.documentElement.style.setProperty('--sidebar-w', this.state.sidebarWidth + 'px');
                    const split = document.getElementById('editor-split');
                    if (this.state.previewType === 'float') split.classList.add('mode-float'); else split.classList.remove('mode-float');

                    if (Editor.instance) {
                        Editor.instance.setFontSize(this.state.fontSize);
                        Editor.instance.setOption("wrap", this.state.wordWrap);
                        Editor.instance.setTheme(this.state.theme === 'latte' ? 'ace/theme/chrome' : 'ace/theme/tomorrow_night_eighties');
                        Editor.instance.resize();
                    }
                }
            };

            const Store = {
                state: { buffers: [], activeId: null, opfsRoot: null, previewMode: false },
                get activeBuffer() { return this.state.buffers.find(b => b.id === this.state.activeId); },
                addBuffer(b) { this.state.buffers.push(b); this.setActive(b.id); App.saveSession(); },
                closeBuffer(id) {
                    const idx = this.state.buffers.findIndex(b => b.id === id);
                    if (idx === -1) return;
                    this.state.buffers.splice(idx, 1);
                    if (this.state.activeId === id) {
                        const next = this.state.buffers[idx] || this.state.buffers[idx - 1];
                        this.setActive(next ? next.id : null);
                    } else UI.renderTabs();
                    App.saveSession();
                    // Update console header (show run button for .js files)
                    try { UI.updateConsoleHeader(); } catch (e) {}
                },
                setActive(id) {
                    this.state.activeId = id; UI.renderTabs();
                    const buf = this.activeBuffer;
                    if (buf) {
                        Editor.load(buf.content, buf.name);
                        document.getElementById('bc-filename').innerText = buf.name;
                    }
                    else { Editor.load('', 'txt'); document.getElementById('bc-filename').innerText = '[No Selection]'; }
                    App.saveSession();
                },
                updateContent(id, c) {
                    const b = this.state.buffers.find(b => b.id === id);
                    if (b && b.content !== c) {
                        b.content = c;
                        if (!b.dirty) { b.dirty = true; UI.renderTabs(); }
                        App.debounceSaveBuffer(b);
                    }
                },
                markSaved(id) {
                    const b = this.state.buffers.find(b => b.id === id);
                    if (b) { b.dirty = false; UI.renderTabs(); App.saveBuffer(b); }
                }
            };

            const Symbols = {
                patterns: {
                    js: [
                        { r: /function\s+([a-zA-Z0-9_$]+)/g, icon: 'f', k: 'func' },
                        { r: /class\s+([a-zA-Z0-9_$]+)/g, icon: 'c', k: 'class' },
                        { r: /(?:const|let|var)\s+([a-zA-Z0-9_$]+)\s*=\s*(?:async\s*)?(?:function|\(.*?\)\s*=>)/g, icon: 'v', k: 'var' }
                    ],
                    py: [
                        { r: /def\s+([a-zA-Z0-9_]+)/g, icon: 'f', k: 'func' },
                        { r: /class\s+([a-zA-Z0-9_]+)/g, icon: 'c', k: 'class' }
                    ],
                    css: [
                        { r: /([.#][a-zA-Z0-9_-]+)\s*\{/g, icon: '#', k: 'sel' }
                    ],
                    md: [
                        { r: /^(#{1,6})\s+(.*)$/gm, icon: 'H', k: 'head' }
                    ]
                },
                parse() {
                    const buf = Store.activeBuffer;
                    if (!buf) return;
                    const ext = buf.name.split('.').pop().toLowerCase();
                    let lang = 'js';
                    if (['ts', 'jsx'].includes(ext)) lang = 'js';
                    else if (ext === 'py') lang = 'py';
                    else if (ext === 'css') lang = 'css';
                    else if (ext === 'md') lang = 'md';
                    else return;

                    const lines = buf.content.split('\n');
                    const tree = document.getElementById('symbol-tree');
                    tree.innerHTML = '';
                    const rules = this.patterns[lang] || [];

                    lines.forEach((line, i) => {
                        rules.forEach(rule => {
                            let match;
                            // Reset regex if global
                            rule.r.lastIndex = 0;
                            while ((match = rule.r.exec(line)) !== null) {
                                const name = lang === 'md' ? match[2] : match[1];
                                const el = document.createElement('div');
                                el.className = 'symbol-item';
                                el.innerHTML = `<span class="symbol-kind">${lang === 'md' ? match[1].length : rule.icon}</span><span class="symbol-name">${name}</span>`;
                                el.onclick = () => { Editor.instance.gotoLine(i + 1); Editor.instance.focus(); };
                                tree.appendChild(el);
                            }
                        });
                    });
                }
            };

            const Editor = {
                instance: null,
                init() {
                        this.instance = ace.edit("code-stage");
                    this.instance.setOptions({
                        enableBasicAutocompletion: true, enableLiveAutocompletion: true,
                        showPrintMargin: false, useSoftTabs: true, tabSize: 4,
                        fontSize: Config.state.fontSize, fontFamily: 'JetBrains Mono, monospace', scrollPastEnd: 0.5
                    });
                    this.instance.on('change', () => {
                        if (Store.state.activeId) Store.updateContent(Store.state.activeId, this.instance.getValue());
                        App.debouncePreview();
                        this.debounceSymbols();
                        // send content to worker for analysis
                        try { if (this.lspWorker) { clearTimeout(this._lspTimer); this._lspTimer = setTimeout(()=> this.lspWorker.postMessage({ type: 'analyze', content: this.instance.getValue() }), 600); } } catch(e){}
                    });
                    this.instance.on('changeSelection', () => App.updateStats());
                    // Shortcuts
                    this.instance.commands.addCommand({ name: 'save', bindKey: { win: 'Ctrl-S', mac: 'Command-S' }, exec: () => Commands.trigger('saveFile') });
                    this.instance.commands.addCommand({ name: 'palette', bindKey: { win: 'F1|Ctrl-P', mac: 'F1|Command-P' }, exec: () => Commands.showPalette() });
                    this.instance.commands.addCommand({ name: 'new', bindKey: { win: 'Alt-N', mac: 'Option-N' }, exec: () => Commands.trigger('newFile') });

                    // Initialize lightweight LSP worker and completer
                    try {
                        this.lspWorker = new Worker('lsp-worker.js');
                        this.lspWorker.addEventListener('message', (e) => {
                            const d = e.data;
                            if (!d) return;
                            if (d.type === 'analyze') {
                                // currently we don't surface diagnostics, but could later
                                this._lspSymbols = d.symbols || [];
                            }
                            if (d.type === 'hover') {
                                if (!this._hoverTip) return;
                                const sig = d.signature;
                                const doc = d.doc;
                                const kind = d.kind || '';
                                if (!sig && !doc) { this._hoverTip.style.display = 'none'; return; }

                                // Build rich content safely
                                this._hoverTip.innerHTML = '';
                                const code = document.createElement('div');
                                code.style.fontFamily = 'JetBrains Mono, monospace';
                                code.style.fontSize = '12px';
                                code.style.fontWeight = '700';
                                code.style.marginBottom = '6px';
                                code.textContent = sig || `${kind}`;
                                this._hoverTip.appendChild(code);

                                if (doc) {
                                    const p = document.createElement('div');
                                    p.style.fontSize = '11px';
                                    p.style.opacity = '0.9';
                                    p.style.whiteSpace = 'pre-wrap';
                                    p.textContent = doc.replace(/^\s*\*\s?/mg, '').trim();
                                    this._hoverTip.appendChild(p);
                                }

                                const x = (this._lastMouse && this._lastMouse.x) || (window.innerWidth/2);
                                const y = (this._lastMouse && this._lastMouse.y) || (window.innerHeight/2);
                                this._hoverTip.style.left = (x + 12) + 'px';
                                this._hoverTip.style.top = (y + 12) + 'px';
                                this._hoverTip.style.display = 'block';
                            }
                        });

                        const completer = {
                            getCompletions: (editor, session, pos, prefix, callback) => {
                                if (!this.lspWorker) return callback(null, []);
                                const content = editor.getValue();
                                const id = 'c' + Date.now() + Math.random();
                                const handler = (ev) => {
                                    const m = ev.data;
                                    if (!m || m.type !== 'complete' || m.id !== id) return;
                                    const items = (m.items || []).map(i => ({ caption: i.caption, value: i.value, meta: i.meta }));
                                    callback(null, items);
                                    this.lspWorker.removeEventListener('message', handler);
                                };
                                this.lspWorker.addEventListener('message', handler);
                                this.lspWorker.postMessage({ type: 'complete', content, prefix, id });
                            }
                        };
                        this.instance.completers = (this.instance.completers || []).concat([completer]);
                        // Create hover tooltip element
                        try {
                            const tip = document.createElement('div');
                            tip.id = 'hover-tip';
                            const cs = getComputedStyle(document.body);
                            tip.style.position = 'fixed';
                            tip.style.display = 'none';
                            tip.style.padding = '6px 8px';
                            tip.style.background = cs.getPropertyValue('--header-bg') || '#222';
                            tip.style.color = cs.getPropertyValue('--text') || '#fff';
                            tip.style.border = `1px solid ${cs.getPropertyValue('--border') || '#333'}`;
                            tip.style.borderRadius = '6px';
                            tip.style.fontSize = '12px';
                            tip.style.zIndex = 9999;
                            tip.style.fontFamily = 'JetBrains Mono, monospace';
                            document.body.appendChild(tip);
                            this._hoverTip = tip;
                            this._lastMouse = null;

                            let hoverTimer = null;
                            // Mouse move over editor, debounce and request hover info
                            this.instance.container.addEventListener('mousemove', (e) => {
                                clearTimeout(hoverTimer);
                                hoverTimer = setTimeout(() => {
                                    try {
                                        const pos = this.instance.renderer.screenToTextCoordinates(e.clientX, e.clientY);
                                        const token = this.instance.session.getTokenAt(pos.row, pos.column);
                                        if (!token) { this._hoverTip.style.display = 'none'; return; }
                                        const word = token.value;
                                        if (!/^[A-Za-z$_][A-Za-z0-9$_]*$/.test(word)) { this._hoverTip.style.display = 'none'; return; }
                                        this._lastMouse = { x: e.clientX, y: e.clientY };
                                        if (this.lspWorker) this.lspWorker.postMessage({ type: 'hover', word, content: this.instance.getValue() });
                                    } catch (err) { this._hoverTip.style.display = 'none'; }
                                }, 180);
                            });

                            this.instance.container.addEventListener('mouseleave', () => { if (this._hoverTip) this._hoverTip.style.display = 'none'; });
                        } catch (e) { /* ignore hover initialization errors */ }
                    } catch (e) { console.warn('LSP worker not available', e); }
                },
                load(content, filename) {
                    if (this.instance.getValue() !== content) this.instance.setValue(content, -1);
                    const ext = filename ? filename.split('.').pop().toLowerCase() : 'txt';
                    const modes = { js: 'javascript', ts: 'javascript', html: 'html', css: 'css', py: 'python', md: 'markdown', json: 'javascript' };
                    this.instance.session.setMode(`ace/mode/${modes[ext] || 'text'}`);
                    this.instance.session.getUndoManager().reset();
                    App.updateStats(); App.debouncePreview(true);
                    Symbols.parse();
                },
                debounceSymbols() {
                    clearTimeout(this.symTimer);
                    this.symTimer = setTimeout(() => Symbols.parse(), 1000);
                }
            };

            const FileSys = {
                rootDir: null,
                async initOPFS() {
                    try {
                        if (!navigator.storage?.getDirectory) throw 1;
                        Store.state.opfsRoot = await navigator.storage.getDirectory();
                        this.renderOPFS();
                    } catch (e) { document.getElementById('opfs-header').innerText = "LocalStorage Only"; }
                },
                async renderOPFS() {
                    if (!Store.state.opfsRoot) return;
                    const div = document.getElementById('opfs-tree');
                    div.innerHTML = '';
                    for await (const [name, handle] of Store.state.opfsRoot.entries()) {
                        if (handle.kind === 'file') {
                            const el = document.createElement('div');
                            el.className = 'tree-item';
                            const label = document.createElement('span');
                            label.className = 'tree-item-label';
                            label.innerHTML = `<svg class="icon" style="width:12px;" viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg> ${name}`;
                            label.onclick = async () => App.openBuffer(name, await (await handle.getFile()).text(), handle, 'opfs');

                            const actions = document.createElement('div');
                            actions.className = 'tree-actions';

                            const renBtn = document.createElement('span');
                            renBtn.className = 'action-btn'; renBtn.title = "Rename";
                            renBtn.innerHTML = `<svg class="icon" style="width:12px;height:12px;" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                            renBtn.onclick = (e) => { e.stopPropagation(); this.renameOPFSFile(name, handle); };

                            const delBtn = document.createElement('span');
                            delBtn.className = 'action-btn action-delete'; delBtn.title = "Delete";
                            delBtn.innerHTML = `<svg class="icon" style="width:12px;height:12px;" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                            delBtn.onclick = (e) => { e.stopPropagation(); this.deleteOPFSFile(name); };

                            actions.append(renBtn, delBtn);
                            el.append(label, actions);
                            div.appendChild(el);
                        }
                    }
                },
                async createOPFSFile() {
                    Prompt.open("New Local File:", "script.js", async (name) => {
                        if (!name) return;
                        try {
                            const handle = await Store.state.opfsRoot.getFileHandle(name, { create: true });
                            App.openBuffer(name, "", handle, 'opfs');
                            this.renderOPFS();
                        } catch (e) { UI.toast('Error creating file'); }
                    });
                },
                async renameOPFSFile(oldName, handle) {
                    Prompt.open(`Rename "${oldName}" to:`, oldName, async (newName) => {
                        if (!newName || newName === oldName) return;
                        try {
                            const file = await handle.getFile();
                            const content = await file.text();
                            const newHandle = await Store.state.opfsRoot.getFileHandle(newName, { create: true });
                            const writable = await newHandle.createWritable();
                            await writable.write(content);
                            await writable.close();
                            await Store.state.opfsRoot.removeEntry(oldName);

                            const buf = Store.state.buffers.find(b => b.name === oldName && b.kind === 'opfs');
                            if (buf) { buf.name = newName; buf.handle = newHandle; UI.renderTabs(); document.getElementById('bc-filename').innerText = newName; }

                            this.renderOPFS(); UI.toast('Renamed');
                        } catch (e) { UI.toast('Rename Failed'); }
                    });
                },
                async deleteOPFSFile(name) {
                    Confirm.open("Delete File", `Permanently delete "${name}"?`, async () => {
                        try {
                            await Store.state.opfsRoot.removeEntry(name);
                            const buf = Store.state.buffers.find(b => b.name === name && b.kind === 'opfs');
                            if (buf) App.closeBuffer(buf.id);
                            this.renderOPFS(); UI.toast('Deleted');
                        } catch (e) { UI.toast('Delete failed'); }
                    });
                },
                async saveBuffer(buf) {
                    if (buf.name === 'config.json' && buf.kind === 'config') { Config.state = JSON.parse(buf.content); Config.save(); Store.markSaved(buf.id); return; }
                    try {
                        let handle = buf.handle;
                        if (!handle && buf.kind === 'memory') {
                            handle = await window.showSaveFilePicker({ suggestedName: buf.name });
                            buf.handle = handle; buf.kind = 'disk'; buf.name = handle.name;
                        }
                        const writable = await handle.createWritable();
                        await writable.write(buf.content);
                        await writable.close();
                        Store.markSaved(buf.id);
                        UI.toast(`Saved: ${buf.name}`);
                    } catch (e) { UI.toast('Save Cancelled'); }
                },
                async openFolder() {
                    try {
                        const handle = await window.showDirectoryPicker();
                        this.rootDir = handle;
                        await DB.set('handles', 'rootDir', handle);
                        this.renderWorkspace(handle);
                    } catch (e) { }
                },
                async openFile() {
                    try {
                        // Use the File System Access API to pick a single file
                        const [handle] = await window.showOpenFilePicker();
                        if (!handle) return;
                        const file = await handle.getFile();
                        const content = await file.text();
                        App.openBuffer(handle.name, content, handle, 'disk');
                    } catch (e) { UI.toast('Open cancelled'); }
                },
                async restoreRoot(handle) {
                    this.rootDir = handle;
                    if ((await handle.queryPermission({ mode: 'read' })) === 'granted') {
                        this.renderWorkspace(handle);
                    } else {
                        document.getElementById('file-tree').innerHTML = `<div class="reconnect-btn" onclick="FileSys.reconnectRoot()">Reconnect to /${handle.name}</div>`;
                    }
                },
                async reconnectRoot() {
                    if (this.rootDir && (await this.rootDir.requestPermission({ mode: 'read' })) === 'granted') {
                        this.renderWorkspace(this.rootDir);
                    }
                },
                async renderWorkspace(dirHandle, parentEl = document.getElementById('file-tree'), level = 0) {
                    if (level === 0) parentEl.innerHTML = '';
                    for await (const [name, handle] of dirHandle.entries()) {
                        const el = document.createElement('div');
                        el.className = 'tree-item';
                        el.style.paddingLeft = `${(level * 10) + 12}px`;
                        el.innerHTML = `${handle.kind === 'directory' ? '+ ' : '> '}${name}`;
                        if (handle.kind === 'file') {
                            el.onclick = async () => App.openBuffer(name, await (await handle.getFile()).text(), handle, 'disk');
                        }
                        parentEl.appendChild(el);
                        if (handle.kind === 'directory') await this.renderWorkspace(handle, parentEl, level + 1);
                    }
                }
            };

            const App = {
                async init() {
                    await DB.init();
                    Editor.init(); Config.init(); FileSys.initOPFS(); Resizer.init(); Dragger.init();

                    const rootHandle = await DB.get('handles', 'rootDir');
                    if (rootHandle) FileSys.restoreRoot(rootHandle);

                    const tabScroll = document.getElementById('tabs-scroll');
                    tabScroll.addEventListener('wheel', (e) => {
                        if (e.deltaY !== 0) {
                            e.preventDefault();
                            tabScroll.scrollLeft += e.deltaY;
                        }
                    }, { passive: false });

                    const welcomeText = "# AETHER v3 // TECHNICAL SPECIFICATION\n" +
                        "> Kernel: Ace Flux 1.32.7\n" +
                        "> Storage Engine: IndexedDB + OPFS (Origin Private File System)\n\n" +
                        "Aether v3 is a browser-based IDE leveraging low-level Web APIs for a local-first development experience. It utilizes an asynchronous non-blocking architecture for file I/O and buffer management.\n\n" +
                        "--- \n\n" +
                        "### SYSTEM ARCHITECTURE & DATA FLOW\n\n" +
                        "The editor handles state persistence through a dual-layer strategy. Buffers are mirrored in IndexedDB to survive page lifecycle events, while the file tree interfaces directly with the host filesystem via the File System Access API.\n\n" +
                        "```text\n" +
                        "    [ UI LAYER ] <--- Event Bus ---> [ COMMAND PALETTE ]\n" +
                        "          |                                |\n" +
                        "    [ ACE ENGINE ] <--- Buffer Sync ---> [ MEMORY CACHE ]\n" +
                        "          |                                |\n" +
                        "    [ VIRTUAL DOM ]                  [ SERIALIZATION ]\n" +
                        "          |                         ________|________\n" +
                        "          |                        |                 |\n" +
                        "    [ WEB WORKERS ]        [ INDEXED DB ]      [ OPFS / DISK ]\n" +
                        "     (Highlighting)         (Session State)     (Persistent I/O)\n" +
                        "```\n\n" +
                        "--- \n\n" +
                        "### CORE FEATURES FOR POWER USERS\n\n" +
                        "| Feature | Implementation Detail |\n" +
                        "| :--- | :--- |\n" +
                        "| Live Preview | Debounced (500ms) iframe injection with srcdoc manipulation |\n" +
                        "| Multi-Cursor | Native Ace implementation; supports Alt+Click or Ctrl+Alt+Up/Down |\n" +
                        "| Theme Engine | CSS Variable injection scoped to data-theme attributes |\n" +
                        "| Persistence | Auto-syncing buffer state to IDB on 'change' events |\n" +
                        "| OPFS | Uses StorageManager.getDirectory() for high-performance sandboxed I/O |\n\n" +
                        "--- \n\n" +
                        "### KEYMAP & MACROS\n\n" +
                        "| Command | Action | Keybinding |\n" +
                        "| :--- | :--- | :--- |\n" +
                        "| palette | Trigger Command Palette | F1 / Ctrl+P |\n" +
                        "| newFile | Initialize Memory Buffer | Alt+N |\n" +
                        "| saveFile | Flush Buffer to Disk/OPFS | Ctrl+S |\n" +
                        "| closeTab | Destroy Active Buffer | Alt+W |\n" +
                        "| toggleWrap | Update Editor Wrap Mode | Internal Only |\n\n" +
                        "--- \n\n" +
                        "### COMPONENT LAYOUT\n\n" +
                        "```text\n" +
                        " ___________________________________________________________________\n" +
                        "| [=] AETHER v3 [v]     [L][F][M][D]  [New][Save][View][Cmd]        |\n" +
                        "|___________________________________________________________________|\n" +
                        "| WORKSPACE [O] |                                                   |\n" +
                        "|---------------| main.js [dirty]  config.json [x]  index.html [x]  |\n" +
                        "| /root         |___________________________________________________|\n" +
                        "|  |_ src/      |                                         |         |\n" +
                        "|  |_ tests/    |        CODE EDITING SURFACE             | LIVE    |\n" +
                        "|               |                                         | PREVIEW |\n" +
                        "| LOCAL STORAGE |        - Syntax Highlighting            |         |\n" +
                        "|  |_ cache.log |        - Emmet Support                  | (MD/    |\n" +
                        "|  |_ dev.env   |        - Code Folding                   |  HTML)  |\n" +
                        "|               |                                         |         |\n" +
                        "|_______________|_________________________________________|_________|\n" +
                        "| ACE | utf-8             Line 1, Col 1 | Indent: 4 | Lang: JS      |\n" +
                        "|___________________________________________________________________|\n" +
                        "```\n\n" +
                        "--- \n\n" +
                        "### ADVANCED CONFIGURATION\n\n" +
                        "You can modify the internal state by opening 'config.json' through the Command Palette. This grants direct access to the `Config.state` object, allowing you to override font scaling, sidebar constants, and Catppuccin flavor variants. \n\n" +
                        "Current Build: 3.1.0-stable\n" +
                        "Render Engine: Tomorrow Night Eighties / Chrome High-Contrast";

                    const savedBuffers = await DB.getAll('session');
                    if (savedBuffers.length) {
                        savedBuffers.forEach(b => Store.addBuffer(b));
                        const active = savedBuffers.find(b => b.active);
                        if (active) Store.setActive(active.id); else Store.setActive(savedBuffers[0].id);
                    } else {
                        // Ensure dirty is false explicitly
                        this.openBuffer('welcome.md', welcomeText, null, 'memory');
                        Store.state.buffers[0].dirty = false;
                        UI.renderTabs();
                    }

                    document.body.addEventListener('dragover', e => { e.preventDefault(); document.body.classList.add('drag-over'); });
                    document.body.addEventListener('dragleave', e => { if (e.relatedTarget === null) document.body.classList.remove('drag-over'); });
                    document.body.addEventListener('drop', async e => {
                        e.preventDefault(); document.body.classList.remove('drag-over');
                        for (const item of e.dataTransfer.items) {
                            if (item.kind === 'file') {
                                const file = item.getAsFile();
                                this.openBuffer(file.name, await file.text(), null, 'memory');
                            }
                        }
                    });

                    // Global shortcut: Ctrl/Cmd+O to open a file
                    document.addEventListener('keydown', (e) => {
                        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'o') {
                            e.preventDefault();
                            Commands.trigger('openFile');
                        }
                    });

                    new ResizeObserver(() => Editor.instance.resize()).observe(document.querySelector('main'));
                },
                openBuffer(name, content, handle, kind) {
                    const existing = Store.state.buffers.find(b => b.name === name);
                    if (existing) return Store.setActive(existing.id);
                    Store.addBuffer({ id: 'b' + Date.now(), name, content, handle, kind, dirty: false });
                },
                updateStats() {
                    if (!Editor.instance) return;
                    const pos = Editor.instance.getCursorPosition();
                    document.getElementById('stat-pos').innerText = `${pos.row + 1}:${pos.column + 1}`;
                    const buf = Store.activeBuffer;
                    if (buf) {
                        document.getElementById('stat-file').innerText = buf.name;
                        document.getElementById('stat-lang').innerText = buf.name.split('.').pop().toUpperCase();
                    }
                },
                debouncePreview(immediate) {
                    if (!Store.state.previewMode) return;
                    clearTimeout(this.pvTimer);
                    const run = () => {
                        const buf = Store.activeBuffer; if (!buf) return;
                        const f = document.getElementById('preview-frame');
                        const ext = buf.name.split('.').pop().toLowerCase();
                        const styles = getComputedStyle(document.body);
                        const baseCss = `body{background:${styles.getPropertyValue('--bg')};color:${styles.getPropertyValue('--text')};font-family:sans-serif;padding:20px;line-height:1.6;}a{color:${styles.getPropertyValue('--accent')}}pre{background:rgba(0,0,0,0.2);padding:10px;border-radius:4px;overflow:auto}code{font-family:'JetBrains Mono',monospace;font-size:0.9em}blockquote{border-left:3px solid ${styles.getPropertyValue('--accent')};padding-left:1em;color:${styles.getPropertyValue('--text-dim')}}`;
                        let html = "";
                        if (ext === 'md') html = `<style>${baseCss}</style>` + marked.parse(buf.content);
                        else if (ext === 'html') html = buf.content;
                        else html = `<style>${baseCss}</style><pre>${buf.content.replace(/</g, '&lt;')}</pre>`;

                            // Use a persistent preview shell and postMessage updates to avoid flashing
                            const shell = `<!doctype html><html><head><meta charset="utf-8"></head><body></body><script>(function(){const _log=console.log,_err=console.error,_warn=console.warn,_info=console.info;console.log=(...args)=>{try{parent.postMessage({type:'console',method:'log',args},'*')}catch(e){};_log.apply(console,args)};console.error=(...args)=>{try{parent.postMessage({type:'console',method:'error',args},'*')}catch(e){};_err.apply(console,args)};console.warn=(...args)=>{try{parent.postMessage({type:'console',method:'warn',args},'*')}catch(e){};_warn.apply(console,args)};console.info=(...args)=>{try{parent.postMessage({type:'console',method:'info',args},'*')}catch(e){};_info.apply(console,args)};window.addEventListener('error',function(ev){try{parent.postMessage({type:'console',method:'error',args:['Uncaught Error: '+(ev.message||ev.error||ev.filename||ev.lineno)]},'*')}catch(e){}});window.addEventListener('message',function(e){if(!e.data) return; if(e.data.type==='update'){ document.body.innerHTML = e.data.html || ''; const scripts = Array.from(document.body.querySelectorAll('script')); scripts.forEach(s=>{ const ns = document.createElement('script'); if(s.src) ns.src = s.src; else ns.textContent = s.textContent; document.head.appendChild(ns); s.parentNode.removeChild(s); }); }});})();<\/script></html>`;

                            const htmlContent = `<style>${baseCss}</style>` + (ext === 'md' ? marked.parse(buf.content) : (ext === 'html' ? buf.content : `<pre>${buf.content.replace(/</g, '&lt;')}</pre>`));

                            // If the shell isn't loaded yet, set it and post the content after load
                            if (!f.dataset.shellReady) {
                                f.onload = () => {
                                    try { f.contentWindow.postMessage({ type: 'update', html: htmlContent }, '*'); } catch (e) {}
                                    f.dataset.shellReady = '1';
                                    f.onload = null;
                                };
                                f.srcdoc = shell;
                            } else {
                                try { f.contentWindow.postMessage({ type: 'update', html: htmlContent }, '*'); } catch (e) {}
                            }
                    };
                    if (immediate) run(); else this.pvTimer = setTimeout(run, 500);
                },
                debounceSaveSession() {
                    clearTimeout(this.saveTimer);
                    this.saveTimer = setTimeout(() => this.saveSession(), 1000); // 1s debounce
                },
                toggleSidebar(side) {
                    document.getElementById(`sidebar-${side}`).classList.toggle('collapsed');
                    setTimeout(() => Editor.instance.resize(), 250);
                },
                runActiveJS() {
                    const buf = Store.activeBuffer;
                    if (!buf) return UI.toast('No active buffer');
                    const ext = buf.name.split('.').pop().toLowerCase();
                    if (ext !== 'js') return UI.toast('Run is for .js files only');

                    // Ensure preview visible
                    Store.state.previewMode = true;
                    document.body.classList.add('preview-active');

                    const styles = getComputedStyle(document.body);
                    const baseCss = `body{background:${styles.getPropertyValue('--bg')};color:${styles.getPropertyValue('--text')};font-family:sans-serif;padding:20px;line-height:1.6;}a{color:${styles.getPropertyValue('--accent')}}pre{background:rgba(0,0,0,0.2);padding:10px;border-radius:4px;overflow:auto}code{font-family:'JetBrains Mono',monospace;font-size:0.9em}`;

                    const safeCode = buf.content.replace(/<\/script>/g, '<\\/script>');

                    const htmlContent = `<style>${baseCss}</style><script>${safeCode}<\/script>`;
                    const f = document.getElementById('preview-frame');

                    // Ensure the persistent shell is loaded (same shell as debouncePreview)
                    const shell = `<!doctype html><html><head><meta charset="utf-8"></head><body></body><script>(function(){const _log=console.log,_err=console.error,_warn=console.warn,_info=console.info;console.log=(...args)=>{try{parent.postMessage({type:'console',method:'log',args},'*')}catch(e){};_log.apply(console,args)};console.error=(...args)=>{try{parent.postMessage({type:'console',method:'error',args},'*')}catch(e){};_err.apply(console,args)};console.warn=(...args)=>{try{parent.postMessage({type:'console',method:'warn',args},'*')}catch(e){};_warn.apply(console,args)};console.info=(...args)=>{try{parent.postMessage({type:'console',method:'info',args},'*')}catch(e){};_info.apply(console,args)};window.addEventListener('error',function(ev){try{parent.postMessage({type:'console',method:'error',args:['Uncaught Error: '+(ev.message||ev.error||ev.filename||ev.lineno)]},'*')}catch(e){}});window.addEventListener('message',function(e){if(!e.data) return; if(e.data.type==='update'){ document.body.innerHTML = e.data.html || ''; const scripts = Array.from(document.body.querySelectorAll('script')); scripts.forEach(s=>{ const ns = document.createElement('script'); if(s.src) ns.src = s.src; else ns.textContent = s.textContent; document.head.appendChild(ns); s.parentNode.removeChild(s); }); }});})();<\/script></html>`;

                    if (!f.dataset.shellReady) {
                        f.onload = () => {
                            try { f.contentWindow.postMessage({ type: 'update', html: htmlContent }, '*'); } catch (e) {}
                            f.dataset.shellReady = '1';
                            f.onload = null;
                        };
                        f.srcdoc = shell;
                    } else {
                        try { f.contentWindow.postMessage({ type: 'update', html: htmlContent }, '*'); } catch (e) {}
                    }

                    setTimeout(() => Editor.instance.resize(), 200);
                },
                async saveSession() {
                    await DB.clear('session');
                    for (const b of Store.state.buffers) {
                        if (b.kind === 'config') continue;
                        await DB.set('session', null, {
                            id: b.id, name: b.name, content: b.content,
                            handle: b.handle, kind: b.kind, dirty: b.dirty,
                            active: b.id === Store.state.activeId
                        });
                    }
                },
                async saveBuffer(b) {
                    if (!b || b.kind === 'config') return;

                    // Recalculate 'active' status based on current Store state
                    // This prevents overwriting the active flag incorrectly if the user switched tabs quickly
                    const isActive = b.id === Store.state.activeId;

                    await DB.set('session', null, {
                        id: b.id,
                        name: b.name,
                        content: b.content,
                        handle: b.handle,
                        kind: b.kind,
                        dirty: b.dirty,
                        active: isActive
                    });
                },

                // Debounce specifically for the single buffer
                debounceSaveBuffer(b) {
                    clearTimeout(this.saveBufTimer);
                    this.saveBufTimer = setTimeout(() => {
                        // Safety check: Ensure buffer wasn't closed while timer was running
                        if (Store.state.buffers.find(x => x.id === b.id)) {
                            this.saveBuffer(b);
                        }
                    }, 1000); // 1 second debounce
                },
            };

            const UI = {
                renderTabs() {
                    const con = document.getElementById('tabs-scroll'); con.innerHTML = '';
                    Store.state.buffers.forEach(b => {
                        const el = document.createElement('div');
                        el.className = `tab ${b.id === Store.state.activeId ? 'active' : ''} ${b.dirty ? 'dirty' : ''}`;
                        el.innerHTML = `<span>${b.name}</span><span class="unsaved-dot"></span><div class="tab-close" onclick="event.stopPropagation(); Store.closeBuffer('${b.id}')"></div>`;
                        el.onclick = () => Store.setActive(b.id);
                        con.appendChild(el);
                        if (b.id === Store.state.activeId) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    });
                },
                toast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('visible'); clearTimeout(this.toastTimer); this.toastTimer = setTimeout(() => t.classList.remove('visible'), 2500); },
                clearConsole() { const logBox = document.getElementById('console-logs'); if (logBox) { logBox.innerHTML = ''; this.toast('Console cleared'); } },
                updateConsoleHeader() {
                    const runBtn = document.getElementById('console-run-btn');
                    if (!runBtn) return;
                    const buf = Store.activeBuffer;
                    const ext = buf && buf.name ? buf.name.split('.').pop().toLowerCase() : '';
                    runBtn.hidden = ext !== 'js';
                }
            };

            const Commands = {
                list: [
                    { id: 'newFile', name: 'New File', hint: 'Alt+N', fn: () => Prompt.open("Filename:", "untitled.js", (n) => App.openBuffer(n, "", null, 'memory')) },
                    { id: 'saveFile', name: 'Save File', hint: 'Ctrl+S', fn: () => Store.activeBuffer && FileSys.saveBuffer(Store.activeBuffer) },
                    { id: 'openFile', name: 'Open File', hint: 'Ctrl+O', fn: () => FileSys.openFile() },
                    { id: 'closeTab', name: 'Close Tab', hint: 'Alt+W', fn: () => Store.activeBuffer && Store.closeBuffer(Store.activeBuffer.id) },
                    { id: 'togglePreview', name: 'Toggle Preview', hint: 'UI', fn: () => { Store.state.previewMode = !Store.state.previewMode; document.body.classList.toggle('preview-active', Store.state.previewMode); App.debouncePreview(true); setTimeout(() => Editor.instance.resize(), 300); } },
                    { id: 'settings', name: 'Edit Settings', hint: 'JSON', fn: () => App.openBuffer('config.json', JSON.stringify(Config.state, null, 4), null, 'config') },
                    { id: 'switchPreview', name: 'Switch Preview Type', hint: 'Split/Float', fn: () => Config.togglePreviewType() },
                    { id: 'wrap', name: 'Toggle Word Wrap', hint: 'View', fn: () => Config.toggleWrap() },
                    { id: 'clear', name: 'Reset App', hint: 'Danger', fn: () => { DB.clear('session'); location.reload(); } },
                    {
                        id: 'format',
                        name: 'Format Document',
                        hint: 'Alt+Shift+F',
                        fn: () => {
                            const val = Editor.instance.getValue();
                            const cursor = Editor.instance.getCursorPosition();
                            try {
                                const formatted = prettier.format(val, {
                                    parser: "babel", // dynamic based on file extension
                                    plugins: prettierPlugins
                                });
                                Editor.instance.setValue(formatted, -1);
                                Editor.instance.moveCursorToPosition(cursor);
                                UI.toast("Formatted!");
                            } catch (e) { UI.toast("Format Error"); }
                        }
                    }
                ],
                trigger(id) { const c = this.list.find(c => c.id === id); if (c) c.fn(); },
                showPalette() {
                    const mask = document.getElementById('palette-mask');
                    const list = document.getElementById('cmd-list');
                    const input = document.getElementById('cmd-input');

                    const render = (filter = '') => {
                        list.innerHTML = '';
                        const terms = filter.toLowerCase();
                        this.list.filter(c => c.name.toLowerCase().includes(terms)).forEach((cmd, idx) => {
                            const el = document.createElement('div'); el.className = 'cmd-item';
                            if (idx === 0) el.classList.add('selected');
                            el.innerHTML = `<span>${cmd.name}</span><span class="cmd-shortcut">${cmd.hint}</span>`;
                            el.onclick = () => { cmd.fn(); this.hidePalette(); };
                            list.appendChild(el);
                        });
                    };

                    mask.style.display = 'flex';
                    input.value = '';
                    input.focus();
                    render();

                    input.oninput = (e) => render(e.target.value);
                    input.onkeydown = (e) => {
                        if (e.key === 'Escape') this.hidePalette();
                        if (e.key === 'Enter') {
                            const first = list.querySelector('.cmd-item');
                            if (first) first.click();
                        }
                    };
                },
                hidePalette() { document.getElementById('palette-mask').style.display = 'none'; Editor.instance.focus(); }
            };

            const Prompt = {
                open(msg, def, cb) {
                    document.getElementById('prompt-mask').style.display = 'flex'; document.getElementById('prompt-msg').innerText = msg;
                    const inp = document.getElementById('prompt-input'); inp.value = def; inp.focus(); inp.select();
                    const sub = () => { if (inp.value) cb(inp.value); this.close(); };
                    document.getElementById('prompt-ok').onclick = sub; inp.onkeydown = (e) => { if (e.key === 'Enter') sub(); if (e.key === 'Escape') this.close(); };
                },
                close() { document.getElementById('prompt-mask').style.display = 'none'; Editor.instance.focus(); }
            };

            const Confirm = {
                open(title, msg, onYes) {
                    document.getElementById('confirm-mask').style.display = 'flex'; document.getElementById('confirm-title').innerText = title;
                    document.getElementById('confirm-msg').innerText = msg; document.getElementById('confirm-ok').onclick = () => { onYes(); this.close(); };
                    document.querySelector('#confirm-mask .btn').focus();
                },
                close() { document.getElementById('confirm-mask').style.display = 'none'; Editor.instance.focus(); }
            };

            const Resizer = {
                init() {
                    // Split Resizer
                    const r = document.getElementById('resizer'); const p = document.getElementById('preview-pane'); let isResizing = false;
                    r.onmousedown = (e) => {
                        if (document.getElementById('editor-split').classList.contains('mode-float')) return;
                        isResizing = true; r.classList.add('active'); document.body.classList.add('resizing'); e.preventDefault();
                    };

                    // Float Resizer
                    const fr = document.getElementById('float-resizer');
                    let isFloatResizing = false;
                    let startX, startY, startW, startH;

                    fr.onmousedown = (e) => {
                        isFloatResizing = true;
                        startX = e.clientX; startY = e.clientY;
                        startW = p.offsetWidth; startH = p.offsetHeight;
                        e.stopPropagation(); e.preventDefault();
                    };

                    document.addEventListener('mousemove', (e) => {
                        if (isResizing) {
                            const w = document.getElementById('editor-split').offsetWidth;
                            const pW = 100 - ((e.clientX - document.getElementById('sidebar-left').offsetWidth) / w * 100);
                            if (pW > 10 && pW < 90) { p.style.width = pW + '%'; Editor.instance.resize(); }
                        }
                        if (isFloatResizing) {
                            p.style.width = (startW + (e.clientX - startX)) + 'px';
                            p.style.height = (startH + (e.clientY - startY)) + 'px';
                        }
                    });

                    document.addEventListener('mouseup', () => {
                        if (isResizing) { isResizing = false; r.classList.remove('active'); document.body.classList.remove('resizing'); Editor.instance.resize(); }
                        if (isFloatResizing) { isFloatResizing = false; }
                    });
                }
            };

            const Dragger = {
                init() {
                    const header = document.getElementById('preview-header');
                    const pane = document.getElementById('preview-pane');
                    let isDragging = false;
                    let startX, startY, initialLeft, initialTop;

                    header.onmousedown = (e) => {
                        if (!document.getElementById('editor-split').classList.contains('mode-float')) return;
                        isDragging = true;
                        document.body.classList.add('dragging-preview');
                        startX = e.clientX;
                        startY = e.clientY;

                        const rect = pane.getBoundingClientRect();
                        const parentRect = document.getElementById('editor-split').getBoundingClientRect();

                        initialLeft = rect.left - parentRect.left;
                        initialTop = rect.top - parentRect.top;

                        pane.style.right = 'auto';
                        pane.style.left = initialLeft + 'px';
                        pane.style.top = initialTop + 'px';
                    };

                    document.addEventListener('mousemove', (e) => {
                        if (!isDragging) return;
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        pane.style.left = (initialLeft + dx) + 'px';
                        pane.style.top = (initialTop + dy) + 'px';
                    });

                    document.addEventListener('mouseup', () => {
                        if (isDragging) {
                            isDragging = false;
                            document.body.classList.remove('dragging-preview');
                        }
                    });
                }
            };

            window.onload = () => App.init();
            window.addEventListener('message', (event) => {
                if (!event.data || event.data.type !== 'console') return;
                const previewFrame = document.getElementById('preview-frame');
                if (!previewFrame || event.source !== previewFrame.contentWindow) return;

                const logBox = document.getElementById('console-logs');
                const entry = document.createElement('div');

                const color = event.data.method === 'error' ? '#ff8888' :
                    event.data.method === 'warn' ? '#ffd700' :
                    event.data.method === 'info' ? '#8fd3ff' : 'var(--text)';

                entry.style.color = color;
                entry.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                entry.style.padding = '2px 0';

                const text = (event.data.args || []).map(a => {
                    try {
                        if (a && a.stack) return a.stack;
                        if (typeof a === 'object') return JSON.stringify(a);
                        return String(a);
                    } catch (e) { return String(a); }
                }).join(' ');

                entry.innerText = `> ${text}`;

                logBox.appendChild(entry);
                const MAX_LOGS = 200;
                while (logBox.children.length > MAX_LOGS) logBox.removeChild(logBox.firstChild);
                logBox.scrollTop = logBox.scrollHeight; // Auto-scroll to bottom
            });
        </script>
    </body>

    </html>