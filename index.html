<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e1e2e">
    <title>Aether v3</title>
    
    <!-- Dependencies: Prism for Highlighting, Marked for Markdown -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            /* Catppuccin Mocha Palette */
            --bg: #1e1e2e; --mantle: #181825; --crust: #11111b;
            --text: #cdd6f4; --subtext: #a6adc8; --overlay: #6c7086;
            --surface: #313244; --base: #1e1e2e;
            --blue: #89b4fa; --lavender: #b4befe; --red: #f38ba8;
            --green: #a6e3a1; --yellow: #f9e2af;
            
            --font-code: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            
            --header-h: 42px;
            --footer-h: 24px;
            --sidebar-w: 220px;
            --tab-h: 32px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background: var(--bg); color: var(--text);
            height: 100dvh; width: 100vw; overflow: hidden;
            font-family: var(--font-ui); display: flex; flex-direction: column;
        }

        /* --- Icons --- */
        svg.icon { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* --- Layout --- */
        #app-shell { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        aside {
            width: var(--sidebar-w); background: var(--mantle); border-right: 1px solid var(--surface);
            display: flex; flex-direction: column; transition: transform 0.2s ease;
            z-index: 10; flex-shrink: 0;
        }
        aside.collapsed { margin-left: calc(var(--sidebar-w) * -1); }
        
        .side-header { padding: 10px; font-size: 0.75rem; font-weight: 700; color: var(--overlay); text-transform: uppercase; letter-spacing: 0.5px; display:flex; justify-content: space-between; align-items: center; }
        .file-tree { flex: 1; overflow-y: auto; padding-bottom: 10px; }
        .tree-item {
            padding: 6px 12px; font-size: 0.8rem; color: var(--subtext); cursor: pointer;
            display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-left: 2px solid transparent;
        }
        .tree-item:hover { background: var(--surface); color: var(--text); }
        .tree-item.active { background: var(--surface); color: var(--blue); border-left-color: var(--blue); }

        /* Main Area */
        main { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }

        /* Tab Bar */
        #tabs-scroll { 
            height: var(--tab-h); background: var(--crust); display: flex; 
            overflow-x: auto; overflow-y: hidden; scrollbar-width: none; 
        }
        #tabs-scroll::-webkit-scrollbar { display: none; }
        
        .tab {
            height: 100%; padding: 0 10px 0 12px; display: flex; align-items: center; gap: 8px;
            background: var(--mantle); color: var(--subtext); font-size: 0.75rem;
            border-right: 1px solid var(--crust); cursor: pointer; min-width: 100px; max-width: 200px;
            user-select: none;
        }
        .tab:hover { background: var(--base); }
        .tab.active { background: var(--base); color: var(--lavender); border-top: 2px solid var(--lavender); }
        .tab-close { opacity: 0; border-radius: 4px; padding: 2px; }
        .tab:hover .tab-close { opacity: 0.7; }
        .tab-close:hover { background: var(--red); color: #fff; opacity: 1; }
        .unsaved-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--yellow); display: none; }
        .tab.dirty .unsaved-dot { display: block; }
        .tab.dirty .tab-close { display: none; }
        .tab.dirty:hover .unsaved-dot { display: none; }
        .tab.dirty:hover .tab-close { display: block; }

        /* Editor Wrapper */
        #editor-split { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* The Code Editor */
        #code-stage { flex: 1; position: relative; overflow: hidden; background: var(--base); }
        
        /* Unified Layer Styles for perfect alignment */
        .code-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            margin: 0; border: none; background: transparent;
            /* Typography */
            font-family: var(--font-code); font-size: 14px; line-height: 21px;
            white-space: pre; word-wrap: normal;
            font-variant-ligatures: none; /* Crucial for cursor alignment */
            /* Spacing - MUST MATCH EXACTLY */
            padding: 10px 0 10px 55px; 
            box-sizing: border-box;
        }

        /* Gutter (Line Numbers) */
        #gutter {
            width: 45px; background: var(--base); color: var(--overlay);
            text-align: right; padding: 10px 12px 10px 0; border-right: 1px solid var(--surface);
            z-index: 5; user-select: none; opacity: 0.6;
            font-family: var(--font-code); font-size: 14px; line-height: 21px;
            overflow: hidden;
            box-sizing: border-box; /* Ensure padding doesn't break width */
        }

        /* Highlight Layer */
        #hl-layer { 
            z-index: 1; 
            pointer-events: none; 
            overflow: hidden; /* Hide scrollbars but allow JS scrolling */
        }
        #hl-layer code { font-family: inherit; }

        /* Input Layer */
        #input-layer {
            z-index: 2; 
            color: transparent; 
            caret-color: var(--blue);
            outline: none; 
            resize: none;
            overflow: auto; /* This layer controls the scroll */
        }
        #input-layer::selection { background: rgba(180, 190, 254, 0.2); }

        /* Preview Pane */
        #preview-pane { 
            width: 0; border-left: 1px solid var(--surface); background: #fff; 
            display: flex; flex-direction: column; overflow: hidden;
            transition: width 0.1s linear; /* Smooth drag */
        }
        .preview-active #preview-pane { width: 40%; }
        iframe { width: 100%; height: 100%; border: none; flex: 1; }
        
        #resizer { 
            width: 4px; background: transparent; cursor: col-resize; position: absolute; right: 0; top: 0; bottom: 0; z-index: 20;
            display: none;
        }
        .preview-active #code-stage #resizer { display: block; right: 0; }
        .preview-active #code-stage { padding-right: 4px; } /* Room for resizer */

        /* Header & Footer */
        header {
            height: var(--header-h); background: var(--mantle); border-bottom: 1px solid var(--crust);
            display: flex; align-items: center; padding: 0 12px; gap: 12px;
        }
        .logo { font-weight: 800; color: var(--lavender); letter-spacing: 1px; margin-right: 8px; font-size: 0.9rem; }
        
        footer {
            height: var(--footer-h); background: var(--mantle); border-top: 1px solid var(--surface);
            display: flex; align-items: center; justify-content: space-between; padding: 0 12px;
            font-size: 11px; color: var(--subtext);
        }

        /* Utilities */
        .btn {
            background: transparent; border: 1px solid transparent; color: var(--subtext);
            padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;
            display: flex; align-items: center; gap: 6px; font-weight: 600;
        }
        .btn:hover { background: var(--surface); color: var(--text); }
        .btn.primary { background: var(--surface); color: var(--blue); border-color: var(--surface); }
        .btn.icon-only { padding: 4px; }
        
        .spacer { flex: 1; }

        /* Dialogs / Overlays */
        .overlay-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
            display: none; align-items: flex-start; justify-content: center; padding-top: 10vh;
            backdrop-filter: blur(2px);
        }
        .dialog {
            background: var(--mantle); border: 1px solid var(--surface); width: 400px;
            border-radius: 8px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; animation: slideDown 0.15s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .dialog input {
            background: var(--crust); border: none; color: var(--text); padding: 12px;
            font-family: inherit; font-size: 14px; width: 100%; border-bottom: 1px solid var(--surface);
        }
        .cmd-item { padding: 8px 12px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; }
        .cmd-item:hover, .cmd-item.selected { background: var(--surface); color: var(--blue); }
        .cmd-shortcut { opacity: 0.5; font-size: 11px; }

        /* Toast */
        #toast {
            position: fixed; bottom: 40px; right: 20px; background: var(--blue); color: var(--mantle);
            padding: 8px 16px; border-radius: 4px; font-size: 12px; font-weight: 700;
            transform: translateY(100px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #toast.visible { transform: translateY(0); }
        #toast.error { background: var(--red); color: #fff; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--base); }
        ::-webkit-scrollbar-thumb { background: var(--surface); border-radius: 5px; border: 2px solid var(--base); }
        ::-webkit-scrollbar-thumb:hover { background: var(--overlay); }
    </style>
</head>
<body>

<!-- Header -->
<header>
    <div class="btn icon-only" onclick="App.toggleSidebar()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
    </div>
    <div class="logo">AETHER v3</div>
    
    <button class="btn" onclick="Commands.trigger('newFile')">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg> New
    </button>
    <button class="btn" onclick="Commands.trigger('openFile')">
        <svg class="icon" viewBox="0 0 24 24"><path d="M9 13h6m-3-3v6m-9 1V7a2 2 0 0 1 2-2h6l2 2h6a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2Z"/></svg> Open
    </button>
    <button class="btn" onclick="Commands.trigger('saveFile')">
        <svg class="icon" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save
    </button>
    
    <div class="spacer"></div>
    
    <button class="btn primary" onclick="Commands.trigger('togglePreview')">
        <svg class="icon" viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg> Preview
    </button>
    <button class="btn icon-only" onclick="Commands.showPalette()">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
    </button>
</header>

<div id="app-shell">
    <!-- Sidebar -->
    <aside id="sidebar">
        <div class="side-header">
            <span>Workspace</span>
            <span class="btn icon-only" onclick="Commands.trigger('openFolder')">
                <svg class="icon" style="width:12px;height:12px" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            </span>
        </div>
        <div id="file-tree" class="file-tree">
            <!-- Dynamic Content -->
            <div style="padding: 20px; text-align: center; color: var(--surface);">No Folder Open</div>
        </div>
        
        <div class="side-header" style="border-top:1px solid var(--surface)">
            <span>OPFS (Local)</span>
            <span class="btn icon-only" onclick="FileSys.initOPFS()">
                <svg class="icon" style="width:12px;height:12px" viewBox="0 0 24 24"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
            </span>
        </div>
        <div id="opfs-tree" class="file-tree" style="height: 150px; min-height: 150px;"></div>
    </aside>

    <main>
        <!-- Tabs -->
        <div id="tabs-scroll"></div>

        <!-- Editor Split -->
        <div id="editor-split">
            <div id="code-stage">
                <div id="gutter"></div>
                <!-- Important: Removed padding-left logic from ID and put it in shared class in CSS -->
                <div id="hl-layer" class="code-layer"><code id="hl-code" class="language-javascript"></code></div>
                <textarea id="input-layer" class="code-layer" spellcheck="false" wrap="off"></textarea>
                <div id="resizer"></div>
            </div>
            
            <div id="preview-pane">
                <iframe id="preview-frame" sandbox="allow-scripts allow-modals allow-forms"></iframe>
            </div>
        </div>
    </main>
</div>

<!-- Footer -->
<footer>
    <div style="display:flex; gap:15px;">
        <span id="stat-file">No File</span>
        <span id="stat-lang">TXT</span>
    </div>
    <div style="display:flex; gap:15px;">
        <span id="stat-pos">Ln 1, Col 1</span>
        <span id="stat-space">Spaces: 4</span>
    </div>
</footer>

<!-- Command Palette -->
<div id="palette-mask" class="overlay-mask" onclick="if(event.target===this) Commands.hidePalette()">
    <div class="dialog">
        <input type="text" id="cmd-input" placeholder="Type a command..." autocomplete="off">
        <div id="cmd-list" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
</div>

<!-- Prompt Dialog -->
<div id="prompt-mask" class="overlay-mask">
    <div class="dialog">
        <div style="padding:12px; font-size:12px; font-weight:700; background:var(--surface); color:var(--blue)" id="prompt-msg">Input</div>
        <input type="text" id="prompt-input" autocomplete="off">
        <div style="display:flex; padding:8px; gap:8px;">
            <button class="btn primary" id="prompt-ok" style="flex:1; justify-content:center;">OK</button>
            <button class="btn" onclick="Prompt.close()" style="flex:1; justify-content:center;">Cancel</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast">Operation Successful</div>

<script>
/**
 * AETHER v3 - CORE LOGIC
 * Architecture:
 * 1. Store: Centralized State
 * 2. EditorEngine: Handling the messy DOM sync
 * 3. FileSys: Handling File API and OPFS
 * 4. App: Glue code and UI logic
 */

// --- 1. STATE STORE ---
const Store = {
    state: {
        buffers: [],      // { id, name, content, handle, kind: 'local'|'disk', dirty: false }
        activeId: null,
        workspace: null,  // FileSystemDirectoryHandle
        opfsRoot: null,
        previewMode: false,
        theme: 'dark'
    },
    subs: [],
    
    get activeBuffer() { return this.state.buffers.find(b => b.id === this.state.activeId); },
    
    subscribe(fn) { this.subs.push(fn); },
    notify(event) { this.subs.forEach(fn => fn(event, this.state)); },
    
    addBuffer(buffer) {
        this.state.buffers.push(buffer);
        this.state.activeId = buffer.id;
        this.notify('buffer_added');
        App.saveSession();
    },
    
    closeBuffer(id) {
        const idx = this.state.buffers.findIndex(b => b.id === id);
        if (idx === -1) return;
        this.state.buffers.splice(idx, 1);
        
        // Determine new active buffer
        if (this.state.activeId === id) {
            this.state.activeId = this.state.buffers.length ? this.state.buffers[Math.max(0, idx - 1)].id : null;
        }
        this.notify('buffer_closed');
        App.saveSession();
    },
    
    setActive(id) {
        if (this.state.activeId === id) return;
        this.state.activeId = id;
        this.notify('buffer_switched');
        App.saveSession();
    },
    
    updateContent(id, content) {
        const b = this.state.buffers.find(b => b.id === id);
        if (b && b.content !== content) {
            b.content = content;
            if (!b.dirty) { b.dirty = true; this.notify('buffer_dirty'); }
        }
    },
    
    markSaved(id) {
        const b = this.state.buffers.find(b => b.id === id);
        if (b) { b.dirty = false; this.notify('buffer_saved'); }
    }
};

// --- 2. EDITOR ENGINE ---
const Editor = {
    els: {
        input: document.getElementById('input-layer'),
        hl: document.getElementById('hl-code'),
        hlLayer: document.getElementById('hl-layer'),
        gutter: document.getElementById('gutter'),
        frame: document.getElementById('code-stage')
    },
    scrolling: false,

    init() {
        // High-performance scroll sync
        this.els.input.addEventListener('scroll', () => {
            if (!this.scrolling) {
                this.scrolling = true;
                requestAnimationFrame(() => {
                    const top = this.els.input.scrollTop;
                    const left = this.els.input.scrollLeft;
                    // Apply scroll to the layer container, not the code element directly
                    this.els.hlLayer.scrollTop = top; 
                    this.els.hlLayer.scrollLeft = left;
                    this.els.gutter.scrollTop = top;
                    this.scrolling = false;
                });
            }
        }, { passive: true });

        // Input Handling
        this.els.input.addEventListener('input', () => {
            const val = this.els.input.value;
            if (Store.state.activeId) Store.updateContent(Store.state.activeId, val);
            this.highlight(val);
            this.updateGutter(val);
            App.debouncePreview();
        });

        // Key Handling (Tab, Save)
        this.els.input.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                document.execCommand('insertText', false, '    ');
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                Commands.trigger('saveFile');
            }
            // Update stats on cursor move
            setTimeout(() => App.updateStats(), 0);
        });

        this.els.input.addEventListener('click', () => App.updateStats());
    },

    load(content, filename) {
        this.els.input.value = content;
        this.highlight(content, filename);
        this.updateGutter(content);
        this.els.input.scrollTop = 0; // Reset scroll
        this.els.hlLayer.scrollTop = 0;
        App.updateStats();
        App.debouncePreview(true);
    },

    highlight(code, filename) {
        // Determine Language
        const buf = Store.activeBuffer;
        const name = filename || (buf ? buf.name : 'txt');
        const ext = name.split('.').pop().toLowerCase();
        
        const map = {
            'js': 'javascript', 'ts': 'javascript', 'py': 'python', 
            'html': 'markup', 'css': 'css', 'json': 'json', 'md': 'markdown'
        };
        const lang = map[ext] || 'clike';
        
        // Prism Highlight
        this.els.hl.className = `language-${lang}`;
        // Escape HTML to prevent injection in the code view
        const safeCode = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        // If Prism has the language, highlight it, else plain text
        if (Prism.languages[lang]) {
            this.els.hl.innerHTML = Prism.highlight(code, Prism.languages[lang], lang) + '<br>'; 
            // <br> ensures the last empty line is rendered
        } else {
            this.els.hl.innerHTML = safeCode + '<br>';
        }
    },

    updateGutter(text) {
        const lines = text.split('\n').length;
        if (this.lastLines === lines) return;
        this.lastLines = lines;
        
        // Rebuild Gutter
        let html = '';
        for (let i = 1; i <= lines; i++) html += `<div>${i}</div>`;
        this.els.gutter.innerHTML = html;
    }
};

// --- 3. FILE SYSTEM ABSTRACT ---
const FileSys = {
    async initOPFS() {
        try {
            Store.state.opfsRoot = await navigator.storage.getDirectory();
            this.renderOPFS();
            UI.toast('OPFS Loaded');
        } catch (e) { UI.toast('OPFS Not Supported', true); }
    },

    async renderOPFS() {
        if (!Store.state.opfsRoot) return;
        const div = document.getElementById('opfs-tree');
        div.innerHTML = '';
        
        for await (const [name, handle] of Store.state.opfsRoot.entries()) {
            if (handle.kind === 'file') {
                const el = document.createElement('div');
                el.className = 'tree-item';
                el.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> ${name}`;
                el.onclick = async () => {
                    const file = await handle.getFile();
                    const text = await file.text();
                    App.openBuffer(name, text, handle, 'opfs');
                };
                div.appendChild(el);
            }
        }
    },

    async openDiskFile() {
        try {
            const [handle] = await window.showOpenFilePicker();
            const file = await handle.getFile();
            App.openBuffer(file.name, await file.text(), handle, 'disk');
        } catch (e) { /* Cancelled */ }
    },
    
    async openFolder() {
        try {
            const handle = await window.showDirectoryPicker();
            Store.state.workspace = handle;
            this.renderWorkspace(handle);
        } catch(e) { /* Cancelled */ }
    },

    async renderWorkspace(dirHandle, parentEl = document.getElementById('file-tree'), level = 0) {
        if(level === 0) parentEl.innerHTML = '';
        
        // Simple flat list for v3 robustness (recursive tree complexity prone to bugs in single file)
        // We will just list files in root for now to keep it robust
        for await (const [name, handle] of dirHandle.entries()) {
            const el = document.createElement('div');
            el.className = 'tree-item';
            el.style.paddingLeft = `${(level * 10) + 12}px`;
            
            if (handle.kind === 'directory') {
                el.innerHTML = `<svg class="icon" style="color:var(--blue)" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg> ${name}`;
                parentEl.appendChild(el);
                // Recursion disabled for stability in this demo, but easy to add click-to-expand
            } else {
                el.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg> ${name}`;
                el.onclick = async () => {
                    const file = await handle.getFile();
                    App.openBuffer(name, await file.text(), handle, 'disk');
                };
                parentEl.appendChild(el);
            }
        }
    },

    async saveBuffer(buf) {
        try {
            if (!buf.handle) {
                // Save As Logic
                buf.handle = await window.showSaveFilePicker({ suggestedName: buf.name });
                buf.name = buf.handle.name;
                buf.kind = 'disk';
            }
            
            const writable = await buf.handle.createWritable();
            await writable.write(buf.content);
            await writable.close();
            
            Store.markSaved(buf.id);
            UI.renderTabs();
            UI.toast(`Saved ${buf.name}`);
        } catch (e) {
            UI.toast('Save Cancelled or Failed', true);
        }
    }
};

// --- 4. APP GLUE ---
const App = {
    init() {
        Store.subscribe((event) => {
            if (event === 'buffer_added' || event === 'buffer_closed' || event === 'buffer_switched') {
                UI.renderTabs();
                const buf = Store.activeBuffer;
                if (buf) Editor.load(buf.content, buf.name);
                else Editor.load('', 'txt');
            }
            if (event === 'buffer_dirty') UI.renderTabs();
        });

        // Load Session
        const saved = JSON.parse(localStorage.getItem('aether_v3_session') || '[]');
        if (saved.length) {
            saved.forEach(s => this.openBuffer(s.name, s.content, null, 'memory'));
        } else {
            this.openBuffer('welcome.md', '# Welcome to Aether v3\n\nStart typing...', null, 'memory');
        }

        Editor.init();
        FileSys.initOPFS(); // Try to load OPFS on boot
    },

    openBuffer(name, content, handle, kind) {
        // Check if already open
        const existing = Store.state.buffers.find(b => b.name === name);
        if (existing) {
            Store.setActive(existing.id);
            return;
        }

        const id = 'buf_' + Date.now() + Math.random().toString(16).slice(2);
        Store.addBuffer({ id, name, content, handle, kind, dirty: false });
    },

    closeBuffer(id, e) {
        if (e) e.stopPropagation();
        const buf = Store.state.buffers.find(b => b.id === id);
        if (buf.dirty) {
            if(!confirm(`Save changes to ${buf.name}?`)) Store.closeBuffer(id);
        } else {
            Store.closeBuffer(id);
        }
    },

    updateStats() {
        const input = document.getElementById('input-layer');
        const text = input.value.substring(0, input.selectionStart);
        const lines = text.split('\n').length;
        const cols = text.split('\n').pop().length + 1;
        
        document.getElementById('stat-pos').innerText = `Ln ${lines}, Col ${cols}`;
        
        const buf = Store.activeBuffer;
        if(buf) {
            document.getElementById('stat-file').innerText = buf.name + (buf.dirty ? '*' : '');
            document.getElementById('stat-lang').innerText = buf.name.split('.').pop().toUpperCase();
        }
    },

    debouncePreview(immediate) {
        if (!Store.state.previewMode) return;
        if (this.pvTimer) clearTimeout(this.pvTimer);
        
        const run = () => {
            const buf = Store.activeBuffer;
            if (!buf) return;
            
            const frame = document.getElementById('preview-frame');
            const ext = buf.name.split('.').pop();
            
            if (ext === 'md') {
                const html = `
                    <style>body{font-family:system-ui;padding:20px;color:#333;line-height:1.6}</style>
                    ${marked.parse(buf.content)}
                `;
                frame.srcdoc = html;
            } else if (ext === 'html') {
                frame.srcdoc = buf.content;
            } else {
                frame.srcdoc = '<div style="font-family:sans-serif;color:#888;padding:20px;text-align:center">No Preview</div>';
            }
        };

        if(immediate) run(); else this.pvTimer = setTimeout(run, 500);
    },

    toggleSidebar() {
        const side = document.getElementById('sidebar');
        side.classList.toggle('collapsed');
    },

    saveSession() {
        // We only save content, not handles (handles can't be serialized easily to LS)
        const serializable = Store.state.buffers.map(b => ({
            name: b.name, content: b.content
        }));
        localStorage.setItem('aether_v3_session', JSON.stringify(serializable));
    }
};

// --- UI UTILS ---
const UI = {
    renderTabs() {
        const con = document.getElementById('tabs-scroll');
        con.innerHTML = '';
        
        Store.state.buffers.forEach(b => {
            const el = document.createElement('div');
            el.className = `tab ${b.id === Store.state.activeId ? 'active' : ''} ${b.dirty ? 'dirty' : ''}`;
            el.innerHTML = `
                <span>${b.name}</span>
                <span class="unsaved-dot"></span>
                <span class="tab-close" onclick="App.closeBuffer('${b.id}', event)">âœ•</span>
            `;
            el.onclick = () => Store.setActive(b.id);
            con.appendChild(el);
            
            // Scroll to active
            if (b.id === Store.state.activeId) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
    },

    toast(msg, isError) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = isError ? 'error' : '';
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 3000);
    }
};

// --- COMMANDS ---
const Commands = {
    list: [
        { id: 'newFile', name: 'New File', fn: () => Prompt.open('Filename:', 'untitled.js', (n) => App.openBuffer(n, '', null, 'memory')) },
        { id: 'openFile', name: 'Open File (Disk)', fn: () => FileSys.openDiskFile() },
        { id: 'openFolder', name: 'Open Folder', fn: () => FileSys.openFolder() },
        { id: 'saveFile', name: 'Save File', fn: () => Store.activeBuffer && FileSys.saveBuffer(Store.activeBuffer) },
        { id: 'togglePreview', name: 'Toggle Preview', fn: () => {
            Store.state.previewMode = !Store.state.previewMode;
            document.body.classList.toggle('preview-active', Store.state.previewMode);
            App.debouncePreview(true);
        }},
        { id: 'theme', name: 'Toggle Sidebar', fn: () => App.toggleSidebar() }
    ],

    trigger(id) { this.list.find(c => c.id === id).fn(); },

    showPalette() {
        const mask = document.getElementById('palette-mask');
        const list = document.getElementById('cmd-list');
        const input = document.getElementById('cmd-input');
        
        list.innerHTML = '';
        this.list.forEach(cmd => {
            const el = document.createElement('div');
            el.className = 'cmd-item';
            el.innerText = cmd.name;
            el.onclick = () => { cmd.fn(); this.hidePalette(); };
            list.appendChild(el);
        });
        
        mask.style.display = 'flex';
        input.value = '';
        input.focus();
        
        // Simple Filter
        input.oninput = () => {
            const term = input.value.toLowerCase();
            Array.from(list.children).forEach(el => {
                el.style.display = el.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        };
        
        input.onkeydown = (e) => { if(e.key === 'Escape') this.hidePalette(); };
    },

    hidePalette() { document.getElementById('palette-mask').style.display = 'none'; document.getElementById('input-layer').focus(); }
};

const Prompt = {
    cb: null,
    open(msg, def, callback) {
        document.getElementById('prompt-mask').style.display = 'flex';
        document.getElementById('prompt-msg').innerText = msg;
        const inp = document.getElementById('prompt-input');
        inp.value = def;
        inp.focus();
        inp.select();
        this.cb = callback;
        
        document.getElementById('prompt-ok').onclick = () => {
            if(inp.value) this.cb(inp.value);
            this.close();
        };
        inp.onkeydown = (e) => {
            if(e.key === 'Enter') document.getElementById('prompt-ok').click();
            if(e.key === 'Escape') this.close();
        };
    },
    close() { document.getElementById('prompt-mask').style.display = 'none'; document.getElementById('input-layer').focus(); }
};

// --- DRAGGABLE RESIZER ---
const Resizer = {
    drag: false,
    init() {
        const r = document.getElementById('resizer');
        const p = document.getElementById('preview-pane');
        r.addEventListener('mousedown', () => { this.drag = true; document.body.style.cursor = 'col-resize'; });
        window.addEventListener('mouseup', () => { this.drag = false; document.body.style.cursor = 'default'; });
        window.addEventListener('mousemove', (e) => {
            if (!this.drag) return;
            const pct = (1 - (e.clientX / window.innerWidth)) * 100;
            p.style.width = Math.max(10, Math.min(90, pct)) + '%';
        });
    }
};

// Boot
window.onload = () => {
    App.init();
    Resizer.init();
    
    // Global Shortcuts
    window.onkeydown = (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') { e.preventDefault(); Commands.showPalette(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'o') { e.preventDefault(); Commands.trigger('openFile'); }
    };
};
</script>
</body>
</html>
